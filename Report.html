<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <title>‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- LIFF + Firebase + jsQR -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script src="firebase-config.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#000000', // ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö Theme ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
            secondary: '#FFFFFF',
            orange: '#E65100', // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°
            lightOrange: '#FFE0B2'
          }
        }
      }
    }
  </script>
</head>

<body class="bg-gray-100 min-h-screen font-sans">
  <!-- Custom Alert -->
  <div id="customAlert"
    class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded shadow hidden z-50">
  </div>

  <div class="max-w-md mx-auto p-6">
    <div class="bg-white p-4 rounded-lg mb-4">
      <h2 class="text-md font-bold">‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
      <p class="pt-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á : <span id="reporterName" class="font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span></p>
    </div>

    <button id="scanBtn"
      class="w-full mb-4 flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-600 text-white py-3 px-4 rounded-full">
      ‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
    </button>
    <video id="video" playsinline class="w-full h-80 object-cover rounded-lg mb-4 hidden"></video>

    <div class="space-y-4">
      <input id="deviceId" type="text" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå" readonly
        class="w-full border border-gray-300 rounded-lg p-2" />
      <input id="deviceName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå" readonly
        class="w-full border border-gray-300 rounded-lg p-2" />
      <input id="title" type="text" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤"
        class="w-full border border-gray-300 rounded-lg p-2" />
      <textarea id="details" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
        class="w-full border border-gray-300 rounded-lg p-2"></textarea>
      <input id="imageInput" type="file" accept="image/*" class="w-full" />
      <img id="previewImage" src="#" alt="Preview" class="w-48 rounded-lg hidden" />
    </div>

    <button id="openConfirmBtn"
      class="w-full my-6 flex items-center justify-center gap-2 bg-orange hover:bg-orange-700 text-white py-3 px-4 rounded-full">
      ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°
    </button>
    <p id="statusText" class="mt-4 text-primary text-center font-medium"></p>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
      <div class="bg-white rounded-lg shadow-lg p-6 w-80">
        <h3 class="text-lg font-semibold mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h3>
        <p class="mb-6">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
        <div class="flex justify-end gap-4">
          <button id="cancelBtn"
            class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button id="confirmBtn"
            class="px-4 py-2 rounded-lg bg-orange hover:bg-orange-700 text-white flex items-center justify-center gap-2">
            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // **********************************************
    // ‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á GAS Web App ‡∏ó‡∏µ‡πà Deploy ‡πÅ‡∏•‡πâ‡∏ß ‚ö†Ô∏è
    // ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Google Apps Script -> Deploy -> New deployment -> Web app -> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "Anyone"
    // ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzhZ-isEXQWK4IFVI7ROkvmHR77QS_b9rKcDux16wrW5vr_wYvNEz8UT92yJwLcGNQq/exec';
    // **********************************************

    // LIFF init
    let userIdLine = "";
    let reporterName = "";
//    let LIFF_ID_REPORT = '2007335399-rmoYp9Md'; // ‡∏Ñ‡∏ß‡∏£‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô firebase-config.js ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Custom Alert
    function showCustomAlert(msg, type = 'error') {
      const alertBox = document.getElementById('customAlert');
      alertBox.textContent = msg;
      if (type === 'success') {
        alertBox.classList.remove('bg-red-500');
        alertBox.classList.add('bg-green-500');
      } else {
        alertBox.classList.remove('bg-green-500');
        alertBox.classList.add('bg-red-500');
      }
      alertBox.classList.remove('hidden');
      setTimeout(() => alertBox.classList.add('hidden'), 3000);
    }

    window.onload = async () => {
      try {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ LIFF_ID_REPORT ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!LIFF_ID_REPORT) {
          showCustomAlert('LIFF ID ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô firebase-config.js ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î');
          return;
        }
        await liff.init({ liffId: LIFF_ID_REPORT });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        if (!liff.isInClient()) {
          // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE app, ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á alert ‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î
          showCustomAlert('‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô LINE Application', 'error');
          setTimeout(() => {
            // ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ liff.closeWindow() ‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô LINE
            // ‡∏≠‡∏≤‡∏à‡∏à‡∏∞ redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏ó‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏£‡∏≤‡∏ö
          }, 3000);
          return;
        }

        const profile = await liff.getProfile();
        userIdLine = profile.userId;

        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏à‡∏≤‡∏Å employees
        const empSnap = await db.ref("employees")
          .orderByChild("userIdLine").equalTo(userIdLine).get();
        if (empSnap.exists()) {
          reporterName = Object.values(empSnap.val())[0].fullName;
        } else {
          showCustomAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô', 'error');
          setTimeout(() => {
            if (liff.isInClient()) liff.closeWindow();
          }, 2000);
          return;
        }
        document.getElementById("reporterName").textContent = reporterName;
      } catch (e) {
        console.error("LIFF Init Error: ", e);
        showCustomAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î LIFF: ' + e.message, 'error');
      }
    };

    // QR scan (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    const canvas = document.createElement('canvas'),
      ctx = canvas.getContext('2d');
    document.getElementById('scanBtn').addEventListener('click', startScan);
    let currentStream; // ‡πÄ‡∏Å‡πá‡∏ö stream ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à

    async function startScan() {
      const video = document.getElementById('video');
      try {
        currentStream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment'
          }
        });
        video.srcObject = currentStream;
        video.play();
        video.classList.remove('hidden');
        requestAnimationFrame(() => scanLoop(video));
      } catch (err) {
        console.error("Error accessing camera: ", err);
        showCustomAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ' + err.message, 'error');
      }
    }

    function scanLoop(video) {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        const code = jsQR(
          ctx.getImageData(0, 0, canvas.width, canvas.height).data,
          canvas.width, canvas.height
        );
        if (code) {
          const id = code.data.trim();
          db.ref(`devices/${id}`).get().then(snap => {
            if (!snap.exists()) {
              showCustomAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', 'error');
              document.getElementById('deviceId').value = '';
              document.getElementById('deviceName').value = '';
            } else {
              document.getElementById('deviceId').value = id;
              document.getElementById('deviceName').value =
                snap.val().deviceName || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠';
              showCustomAlert('‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            }
          }).catch(err => {
            console.error("Firebase read error:", err);
            showCustomAlert('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ' + err.message, 'error');
          });

          // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
          if (currentStream) {
            currentStream.getTracks().forEach(t => t.stop());
            video.srcObject = null;
          }
          video.classList.add('hidden');
          return; // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å loop
        }
      }
      if (currentStream && video.srcObject) requestAnimationFrame(() => scanLoop(video));
    }


    // Preview image (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    document.getElementById('imageInput')
      .addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = ev => {
            const img = document.getElementById('previewImage');
            img.src = ev.target.result;
            img.classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        }
      });

    // Modal control (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    const modal = document.getElementById('confirmModal');
    document.getElementById('openConfirmBtn').addEventListener('click', () => {
      const dev = document.getElementById('deviceId').value.trim();
      const ti = document.getElementById('title').value.trim();
      const dt = document.getElementById('details').value.trim();
      if (!dev || !ti || !dt) {
        showCustomAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
        return;
      }
      modal.classList.remove('hidden');
    });
    document.getElementById('cancelBtn')
      .addEventListener('click', () => modal.classList.add('hidden'));

    // ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ confirmBtn ‡πÅ‡∏™‡∏î‡∏á loading state ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏¢
    document.getElementById('confirmBtn')
      .addEventListener('click', async function () {
        const btn = this;
        const originalHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `
          <svg class="animate-spin h-5 w-5 inline-block" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
        `;
        try {
          await submitRepair();
          btn.innerHTML = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
          showCustomAlert('‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
          setTimeout(() => {
            if (liff.isInClient()) liff.closeWindow();
          }, 1500); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        } catch (error) {
          console.error("Submission failed:", error);
          btn.innerHTML = originalHTML; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
          btn.disabled = false;
          showCustomAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°: ' + error.message, 'error');
        } finally {
          modal.classList.add('hidden'); // ‡∏õ‡∏¥‡∏î modal ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
        }
      });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase + ‡∏™‡πà‡∏á LINE ‡∏ú‡πà‡∏≤‡∏ô GAS Web App
    async function submitRepair() {
      const id = db.ref().child('repairReports').push().key; // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°
      const now = new Date().toISOString();
      const dev = document.getElementById('deviceId').value.trim();
      const devName = document.getElementById('deviceName').value.trim();
      const ti = document.getElementById('title').value.trim();
      const dt = document.getElementById('details').value.trim();
      const file = document.getElementById('imageInput').files[0];

      let imageUrl = '';
      if (file) {
        try {
          const snap = await storage.ref(`repair_images/${id}`).put(file);
          imageUrl = await snap.ref.getDownloadURL();
        } catch (err) {
          console.error("Image upload failed:", err);
          showCustomAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ: ' + err.message, 'error');
          // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á throw error ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        }
      }

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase Realtime Database
      await db.ref(`repairReports/${id}`).set({
        id,
        date: now,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        reporterName,
        userIdLine,
        deviceId: dev,
        deviceName: devName,
        title: ti,
        details: dt,
        status: '‡∏£‡∏≠‡∏ã‡πà‡∏≠‡∏°',
        imageUrl
      });

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô Firebase Realtime Database
      await db.ref(`devices/${dev}`).update({
        status: '‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°',
        lastUser: reporterName,
        lastUserId: userIdLine,
        lastRepairReportId: id // ‡πÄ‡∏û‡∏¥‡πà‡∏° field ‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°
      });

      // üö® ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á GAS Web App ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ App Script ‡∏™‡πà‡∏á Flex Message
      const payload = {
        action: 'repair', // ‡∏£‡∏∞‡∏ö‡∏∏ action ‡πÄ‡∏õ‡πá‡∏ô 'repair'
        deviceId: dev,
        deviceName: devName,
        title: ti,
        details: dt,
        reporterName: reporterName,
        userIdLine: userIdLine,
        imageUrl: imageUrl // ‡∏™‡πà‡∏á URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
      };

      const response = await fetch(GAS_WEB_APP_URL, {
        method: 'POST',
        body: JSON.stringify(payload),
      });

      const responseData = await response.json();
      if (response.ok && responseData.status === 'success') {
        console.log('Flex message sent successfully via GAS:', responseData);
      } else {
        console.error('Failed to send Flex message via GAS:', responseData);
        throw new Error(responseData.message || 'Unknown error from GAS');
      }
    }
  </script>
</body>

</html>
