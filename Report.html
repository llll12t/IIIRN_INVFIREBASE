<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <title>แจ้งซ่อมอุปกรณ์สำเร็จ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- LIFF + Firebase -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  <!-- ต้องมีไฟล์ firebase-config.js ที่กำหนดค่า Firebase และ LIFF_ID_COMPLETE -->
  <script src="firebase-config.js"></script> 
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#155724', // สีเขียวสำหรับซ่อมสำเร็จ
            secondary: '#FFFFFF',
            lightGreen: '#D4EDDA'
          }
        }
      }
    }
  </script>
  <style>
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen font-sans">
  <!-- Custom Alert -->
  <div id="customAlert"
    class="fixed top-4 left-1/2 transform -translate-x-1/2 text-white px-4 py-2 rounded shadow hidden z-50 transition-opacity duration-300 ease-in-out opacity-0">
  </div>

  <div class="max-w-md mx-auto p-6">
    <div class="bg-white p-4 rounded-lg mb-4">
      <h2 class="text-md font-bold text-primary">แจ้งซ่อมอุปกรณ์สำเร็จ</h2>
      <p class="pt-2">ผู้ดำเนินการ: <span id="repairerNameDisplay" class="font-medium">กำลังโหลด...</span></p>
    </div>

    <!-- UI สำหรับเลือก/ค้นหารายงานซ่อม -->
    <div class="bg-white p-4 rounded-lg mb-4 shadow-sm">
        <h3 class="font-semibold text-lg mb-3 text-gray-700">เลือกรหัสอุปกรณ์ที่ซ่อมสำเร็จ</h3>
        <input id="selectDeviceId" type="text" placeholder="พิมพ์รหัสอุปกรณ์ หรือ สแกน QR"
            class="w-full border border-gray-300 rounded-lg p-2 mb-2 focus:ring-primary focus:border-primary" />
        <button id="searchDeviceBtn"
            class="w-full flex items-center justify-center gap-2 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-full transition-colors duration-200">
            ค้นหาอุปกรณ์
        </button>
        <button id="scanDeviceBtn"
            class="w-full mt-2 flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-600 text-white py-2 px-4 rounded-full">
            สแกน QR อุปกรณ์
        </button>
        <video id="video" playsinline class="w-full h-80 object-cover rounded-lg mb-4 hidden"></video>

        <p id="selectedDeviceSummary" class="mt-3 text-gray-600 hidden">
            **อุปกรณ์:** <span id="summaryDeviceId" class="font-medium"></span> - <span id="summaryDeviceName" class="font-medium"></span><br>
            **แจ้งโดย:** <span id="summaryOriginalReporter" class="font-medium"></span>
        </p>
    </div>

    <!-- ฟอร์มสำหรับกรอกข้อมูลการซ่อมสำเร็จ -->
    <div id="repairCompletionForm" class="space-y-4 bg-white p-4 rounded-lg shadow-sm hidden">
      <h3 class="font-semibold text-lg mb-3 text-gray-700">รายละเอียดการซ่อมสำเร็จ</h3>
      <textarea id="repairNotes" placeholder="สรุปการซ่อม / รายละเอียดการแก้ไข" rows="5"
        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-primary focus:border-primary"></textarea>
      <input id="imageInputComplete" type="file" accept="image/*" class="w-full file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100" />
      <img id="previewImageComplete" src="#" alt="Preview" class="w-full max-w-xs h-auto rounded-lg hidden mt-2 mx-auto" />

      <button id="openConfirmCompleteBtn"
        class="w-full mt-6 flex items-center justify-center gap-2 bg-primary hover:bg-green-700 text-white py-3 px-4 rounded-full transition-colors duration-200">
        ส่งแจ้งซ่อมสำเร็จ
      </button>
    </div>

    <!-- Confirmation Modal for Completion -->
    <div id="confirmCompleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
      <div class="bg-white rounded-lg shadow-lg p-6 w-80 max-w-sm">
        <h3 class="text-lg font-semibold mb-4 text-center">ยืนยันการแจ้งซ่อมสำเร็จ</h3>
        <p class="mb-6 text-center text-gray-700">ต้องการส่งแจ้งซ่อมสำเร็จใช่หรือไม่?</p>
        <div class="flex justify-end gap-4">
          <button id="cancelCompleteBtn"
            class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 transition-colors duration-200">ยกเลิก</button>
          <button id="confirmCompleteBtn"
            class="px-4 py-2 rounded-lg bg-primary hover:bg-green-700 text-white flex items-center justify-center gap-2 transition-colors duration-200">
            ยืนยัน
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script>
    // **********************************************
    // ⚠️ สำคัญมาก: เปลี่ยนค่านี้เป็น URL ของ GAS Web App ที่ Deploy แล้ว ⚠️
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzhZ-isEXQWK4IFVI7ROkvmHR77QS_b9rKcDux16wrW5vr_wYvNEz8UT92yJwLcGNQq/exec';
    // **********************************************

    // LIFF init variables
    let repairerUserIdLine = "";
    let repairerName = "";
    let selectedRepairReport = null; // เก็บข้อมูลรายงานซ่อมที่ถูกเลือก

    // LIFF ID สำหรับแจ้งซ่อมสำเร็จ (ควรถูกกำหนดใน firebase-config.js)
    // ตัวอย่าง: const LIFF_ID_COMPLETE = 'your-liff-id-for-completion'; 

    function showCustomAlert(msg, type = 'error') {
      const alertBox = document.getElementById('customAlert');
      alertBox.textContent = msg;
      alertBox.classList.remove('opacity-0', 'hidden');
      alertBox.classList.add('opacity-100');
      
      if (type === 'success') {
        alertBox.classList.remove('bg-red-500');
        alertBox.classList.add('bg-green-500');
      } else {
        alertBox.classList.remove('bg-green-500');
        alertBox.classList.add('bg-red-500');
      }
      
      setTimeout(() => {
        alertBox.classList.remove('opacity-100');
        alertBox.classList.add('opacity-0');
        setTimeout(() => alertBox.classList.add('hidden'), 300);
      }, 3000);
    }

    window.onload = async () => {
      try {
        if (typeof LIFF_ID_COMPLETE === 'undefined') {
          showCustomAlert('LIFF ID สำหรับการแจ้งซ่อมสำเร็จไม่ได้ถูกกำหนด', 'error');
          return;
        }

        await liff.init({ liffId: LIFF_ID_COMPLETE });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        if (!liff.isInClient()) {
          showCustomAlert('โปรดเปิดหน้านี้ใน LINE Application', 'error');
          return;
        }

        const profile = await liff.getProfile();
        repairerUserIdLine = profile.userId;

        // ค้นหาชื่อผู้ดำเนินการจาก employees
        const empSnap = await db.ref("employees")
          .orderByChild("userIdLine").equalTo(repairerUserIdLine).get();
        if (empSnap.exists()) {
          repairerName = Object.values(empSnap.val())[0].fullName;
        } else {
          showCustomAlert('ไม่พบข้อมูลพนักงาน กรุณาลงทะเบียนในระบบก่อน', 'error');
          setTimeout(() => {
            if (liff.isInClient()) liff.closeWindow();
          }, 2000);
          return;
        }
        document.getElementById("repairerNameDisplay").textContent = repairerName;
      } catch (e) {
        console.error("LIFF Init Error: ", e);
        showCustomAlert('เกิดข้อผิดพลาดในการโหลด LIFF: ' + e.message, 'error');
      }
    };

    // --- QR Scan for Device ID (similar to initial repair LIFF) ---
    const canvas = document.createElement('canvas'), ctx = canvas.getContext('2d');
    document.getElementById('scanDeviceBtn').addEventListener('click', startScan);
    let currentStream;

    async function startScan() {
        const video = document.getElementById('video');
        try {
            currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = currentStream;
            video.play();
            video.classList.remove('hidden');
            requestAnimationFrame(() => scanLoop(video));
        } catch (err) {
            console.error("Error accessing camera: ", err);
            showCustomAlert('ไม่สามารถเข้าถึงกล้องได้: ' + err.message + ' (โปรดตรวจสอบสิทธิ์การเข้าถึงกล้อง)', 'error');
        }
    }

    function scanLoop(video) {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            const code = jsQR(ctx.getImageData(0, 0, canvas.width, canvas.height).data, canvas.width, canvas.height);
            if (code) {
                document.getElementById('selectDeviceId').value = code.data.trim();
                searchDevice(); // ค้นหาอุปกรณ์หลังจากสแกนได้
                // หยุดกล้อง
                if (currentStream) {
                    currentStream.getTracks().forEach(t => t.stop());
                    video.srcObject = null;
                }
                video.classList.add('hidden');
                return;
            }
        }
        if (currentStream && video.srcObject) requestAnimationFrame(() => scanLoop(video));
    }

    // --- Search Device and Load Repair Report ---
    document.getElementById('searchDeviceBtn').addEventListener('click', searchDevice);

    async function searchDevice() {
        const deviceId = document.getElementById('selectDeviceId').value.trim();
        if (!deviceId) {
            showCustomAlert('กรุณากรอกรหัสอุปกรณ์', 'error');
            return;
        }

        try {
            // 1. ค้นหาอุปกรณ์ใน 'devices' เพื่อยืนยันว่ามีอยู่จริง
            const deviceSnap = await db.ref(`devices/${deviceId}`).get();
            if (!deviceSnap.exists()) {
                showCustomAlert('ไม่พบอุปกรณ์นี้ในระบบ', 'error');
                resetForm();
                return;
            }
            const deviceData = deviceSnap.val();
            const deviceName = deviceData.deviceName || 'ไม่ทราบชื่อ';

            // 2. ค้นหารายงานซ่อมล่าสุดสำหรับอุปกรณ์นี้ที่มีสถานะ 'รอซ่อม' หรือ 'ส่งซ่อม'
            const repairSnap = await db.ref("repairReports")
                .orderByChild("deviceId").equalTo(deviceId)
                .limitToLast(1) // เอาแค่รายงานล่าสุด
                .get();
            
            let foundReport = null;
            repairSnap.forEach(childSnap => {
                const report = childSnap.val();
                if (report.status === 'รอซ่อม' || report.status === 'ส่งซ่อม') {
                    foundReport = report;
                }
            });

            if (!foundReport) {
                showCustomAlert('ไม่พบรายงานซ่อมที่รอซ่อมสำหรับอุปกรณ์นี้', 'error');
                resetForm();
                return;
            }
            
            selectedRepairReport = foundReport; // เก็บข้อมูลรายงานซ่อม
            
            // แสดงข้อมูลสรุป
            document.getElementById('summaryDeviceId').textContent = selectedRepairReport.deviceId;
            document.getElementById('summaryDeviceName').textContent = selectedRepairReport.deviceName;
            document.getElementById('summaryOriginalReporter').textContent = selectedRepairReport.reporterName || 'ไม่ระบุ';
            document.getElementById('selectedDeviceSummary').classList.remove('hidden');
            document.getElementById('repairCompletionForm').classList.remove('hidden'); // แสดงฟอร์มเมื่อพบ

            showCustomAlert('พบรายงานซ่อมที่รอซ่อม!', 'success');

        } catch (err) {
            console.error("Error searching device/repair report:", err);
            showCustomAlert('เกิดข้อผิดพลาดในการค้นหา: ' + err.message, 'error');
            resetForm();
        }
    }

    function resetForm() {
        selectedRepairReport = null;
        document.getElementById('selectedDeviceSummary').classList.add('hidden');
        document.getElementById('repairCompletionForm').classList.add('hidden');
        document.getElementById('repairNotes').value = '';
        document.getElementById('imageInputComplete').value = '';
        document.getElementById('previewImageComplete').classList.add('hidden');
        document.getElementById('previewImageComplete').src = '#';
    }

    // Preview image for completion
    document.getElementById('imageInputComplete')
      .addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = ev => {
            const img = document.getElementById('previewImageComplete');
            img.src = ev.target.result;
            img.classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        } else {
            document.getElementById('previewImageComplete').classList.add('hidden');
            document.getElementById('previewImageComplete').src = '#';
        }
      });

    // Modal control for completion
    const modalComplete = document.getElementById('confirmCompleteModal');
    document.getElementById('openConfirmCompleteBtn').addEventListener('click', () => {
      if (!selectedRepairReport) {
        showCustomAlert('กรุณาเลือกอุปกรณ์และรายงานซ่อมก่อน', 'error');
        return;
      }
      const notes = document.getElementById('repairNotes').value.trim();
      if (!notes) {
        showCustomAlert('กรุณากรอกสรุปการซ่อม', 'error');
        return;
      }
      modalComplete.classList.remove('hidden');
    });
    document.getElementById('cancelCompleteBtn')
      .addEventListener('click', () => modalComplete.classList.add('hidden'));

    // Submit completion button logic
    document.getElementById('confirmCompleteBtn')
      .addEventListener('click', async function () {
        const btn = this;
        const originalHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `
          <svg class="animate-spin h-5 w-5 inline-block text-white" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          กำลังบันทึก...
        `;
        try {
          await submitRepairCompletion();
          btn.innerHTML = '✅ บันทึกสำเร็จ';
          showCustomAlert('ส่งแจ้งซ่อมสำเร็จ!', 'success');
          setTimeout(() => {
            if (liff.isInClient()) liff.closeWindow();
          }, 1500);
        } catch (error) {
          console.error("Completion submission failed:", error);
          btn.innerHTML = originalHTML;
          btn.disabled = false;
          showCustomAlert('เกิดข้อผิดพลาดในการแจ้งซ่อมสำเร็จ: ' + error.message, 'error');
        } finally {
          modalComplete.classList.add('hidden');
        }
      });

    // ฟังก์ชันบันทึกการซ่อมสำเร็จและส่งแจ้งเตือน
    async function submitRepairCompletion() {
      if (!selectedRepairReport) {
        throw new Error('ไม่พบรายงานซ่อมที่เลือก');
      }

      const repairReportId = selectedRepairReport.id;
      const now = new Date().toISOString();
      const repairNotes = document.getElementById('repairNotes').value.trim();
      const file = document.getElementById('imageInputComplete').files[0];

      let imageUrl = '';
      if (file) {
        try {
          // อัปโหลดรูปภาพหลังซ่อมแยกต่างหาก หรือใช้ ID เดิม (แนะนำแยก)
          const snap = await storage.ref(`repair_complete_images/${repairReportId}`).put(file);
          imageUrl = await snap.ref.getDownloadURL();
        } catch (err) {
          console.error("Image upload failed:", err);
          showCustomAlert('ไม่สามารถอัปโหลดรูปภาพได้: ' + err.message, 'error');
        }
      }

      // อัปเดตสถานะในรายงานซ่อมเดิม
      await db.ref(`repairReports/${repairReportId}`).update({
        status: 'ซ่อมสำเร็จ',
        repairerName: repairerName,
        repairerUserIdLine: repairerUserIdLine,
        repairCompletionDate: now,
        repairNotes: repairNotes,
        repairImageUrl: imageUrl // URL รูปภาพหลังซ่อม
      });

      // อัปเดตสถานะอุปกรณ์กลับเป็น 'พร้อมใช้งาน'
      await db.ref(`devices/${selectedRepairReport.deviceId}`).update({
        status: 'พร้อมใช้งาน',
        lastUser: repairerName,
        lastUserId: repairerUserIdLine
      });

      // ส่งข้อมูลไปยัง GAS Web App เพื่อส่ง Flex Message แจ้งซ่อมสำเร็จ
      const payload = {
        action: 'repair_complete',
        deviceId: selectedRepairReport.deviceId,
        deviceName: selectedRepairReport.deviceName,
        repairerName: repairerName,
        repairerUserIdLine: repairerUserIdLine,
        repairNotes: repairNotes,
        imageUrl: imageUrl,
        originalReporterName: selectedRepairReport.reporterName, // ดึงมาจากรายงานซ่อมเดิม
        originalReporterUserIdLine: selectedRepairReport.userIdLine // ดึงมาจากรายงานซ่อมเดิม
      };

      if (!GAS_WEB_APP_URL || GAS_WEB_APP_URL === 'YOUR_DEPLOYED_GAS_WEB_APP_URL') {
        throw new Error('กรุณาตั้งค่า GAS_WEB_APP_URL ในโค้ด LIFF.');
      }

      const response = await fetch(GAS_WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      const responseData = await response.json();
      if (response.ok && responseData.status === 'success') {
        console.log('Flex message sent successfully via GAS:', responseData);
      } else {
        console.error('Failed to send Flex message via GAS:', responseData);
        throw new Error(responseData.message || 'Unknown error from GAS');
      }
    }
  </script>
</body>

</html>
