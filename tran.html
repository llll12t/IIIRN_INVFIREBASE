<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ระบบคลังสินค้า (LIFF Mode)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <!-- jsQR for QR scanning -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <!-- Your Firebase config -->
  <script src="firebase-config.js"></script>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

  <!-- Alert -->
  <div id="customAlert"
       class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded shadow hidden z-50">
  </div>

  <div class="max-w-lg mx-auto p-6 space-y-6">
    <!-- Tabs -->
    <div class="flex mb-4 border-b">
      <button id="tabIssueBtn"
              class="flex-1 py-2 text-center border-b-2 border-primary font-semibold">
        เบิก
      </button>
      <button id="tabReceiveBtn"
              class="flex-1 py-2 text-center border-b-2 border-transparent hover:border-primary">
        รับเข้า
      </button>
      <button id="tabHistoryBtn"
              class="flex-1 py-2 text-center border-b-2 border-transparent hover:border-primary">
        ประวัติ
      </button>
    </div>

    <!-- เบิก Form -->
    <div id="tabIssue">
      <h2 class="text-lg font-semibold mb-2">เบิกสินค้า (<span id="issueActorName">–</span>)</h2>
      <datalist id="inventoryList"></datalist>
      <input list="inventoryList" id="issCodeInput"
             placeholder="พิมพ์รหัสหรือชื่อสินค้า"
             class="w-full border rounded p-2 mb-2" />
      <button id="issScanBtn"
              class="w-full mb-4 bg-red-600 hover:bg-red-500 text-white py-2 rounded">
        สแกน QR
      </button>
      <video id="issVideo" playsinline class="w-full h-48 object-cover rounded mb-4 hidden"></video>
      <p id="issStockInfo" class="text-sm text-gray-600 mb-2">คงเหลือ: –</p>
      <input id="issQty" type="number" min="1" value="1"
             placeholder="จำนวนเบิก" class="w-full border rounded p-2 mb-4" />
      <button id="issSubmit"
              class="w-full bg-red-600 hover:bg-red-500 text-white py-2 rounded">
        เบิก
      </button>
    </div>

    <!-- รับเข้า Form -->
    <div id="tabReceive" class="hidden">
      <h2 class="text-lg font-semibold mb-2">รับเข้าสินค้า (<span id="receiveActorName">–</span>)</h2>
      <input list="inventoryList" id="recvCodeInput"
             placeholder="พิมพ์รหัสหรือชื่อสินค้า"
             class="w-full border rounded p-2 mb-2" />
      <button id="recvScanBtn"
              class="w-full mb-4 bg-green-600 hover:bg-green-500 text-white py-2 rounded">
        สแกน QR
      </button>
      <video id="recvVideo" playsinline class="w-full h-48 object-cover rounded mb-4 hidden"></video>
      <p id="recvStockInfo" class="text-sm text-gray-600 mb-2">คงเหลือ: –</p>
      <input id="recvQty" type="number" min="1" value="1"
             placeholder="จำนวนรับเข้า" class="w-full border rounded p-2 mb-4" />
      <button id="recvSubmit"
              class="w-full bg-green-600 hover:bg-green-500 text-white py-2 rounded">
        รับเข้า
      </button>
    </div>

    <!-- ประวัติ Table -->
    <div id="tabHistory" class="hidden">
      <div class="overflow-x-auto bg-white rounded shadow mb-2">
        <table class="min-w-full text-left">
          <thead class="bg-gray-200">
            <tr>
              <th class="px-4 py-2">วันที่</th>
              <th class="px-4 py-2">ชื่อสินค้า</th>
              <th class="px-4 py-2">จำนวน (ชิ้น)</th>
            </tr>
          </thead>
          <tbody id="historyTable" class="divide-y"></tbody>
        </table>
      </div>
      <div class="flex justify-between items-center">
        <button id="historyPrev"
                class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50"
                disabled>ก่อนหน้า</button>
        <span id="historyPageInfo" class="text-sm text-gray-600">หน้าที่ 1 จาก 1</span>
        <button id="historyNext"
                class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50"
                disabled>ถัดไป</button>
      </div>
    </div>
  </div>

  <script>
    // LIFF + Firebase refs
    const LIFF_ID       = '2007335399-rmoYp9Md';
    const stockRef      = db.ref('stock');
    const receiveRef    = db.ref('receiveRecords');
    const issueRef      = db.ref('issueRecords');
    const employeesRef  = db.ref('employees');

    let userIdLine = '', borrowerName = '';
    let historyRecords = [], historyPage = 1;
    const historyPageSize = 15;

    // Tabs
    const tabIssueBtn   = document.getElementById('tabIssueBtn');
    const tabReceiveBtn = document.getElementById('tabReceiveBtn');
    const tabHistoryBtn = document.getElementById('tabHistoryBtn');
    const tabIssue      = document.getElementById('tabIssue');
    const tabReceive    = document.getElementById('tabReceive');
    const tabHistory    = document.getElementById('tabHistory');

    tabIssueBtn.onclick = () => {
      tabIssue.classList.remove('hidden');
      tabReceive.classList.add('hidden');
      tabHistory.classList.add('hidden');
      tabIssueBtn.classList.add('border-primary','font-semibold');
      tabReceiveBtn.classList.remove('border-primary','font-semibold');
      tabHistoryBtn.classList.remove('border-primary','font-semibold');
    };
    tabReceiveBtn.onclick = () => {
      tabReceive.classList.remove('hidden');
      tabIssue.classList.add('hidden');
      tabHistory.classList.add('hidden');
      tabReceiveBtn.classList.add('border-primary','font-semibold');
      tabIssueBtn.classList.remove('border-primary','font-semibold');
      tabHistoryBtn.classList.remove('border-primary','font-semibold');
    };
    tabHistoryBtn.onclick = () => {
      tabHistory.classList.remove('hidden');
      tabIssue.classList.add('hidden');
      tabReceive.classList.add('hidden');
      tabHistoryBtn.classList.add('border-primary','font-semibold');
      tabIssueBtn.classList.remove('border-primary','font-semibold');
      tabReceiveBtn.classList.remove('border-primary','font-semibold');
      loadHistory();
    };

    function showCustomAlert(msg) {
      const a = document.getElementById('customAlert');
      a.textContent = msg;
      a.classList.remove('hidden');
      setTimeout(()=>a.classList.add('hidden'),3000);
    }

    window.onload = async () => {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isInClient() && !liff.isLoggedIn()) {
        liff.login(); return;
      }
      const profile = await liff.getProfile();
      userIdLine = profile.userId;

      // lookup employee
      const empSnap = await employeesRef
        .orderByChild('userIdLine').equalTo(userIdLine).get();
      borrowerName = empSnap.exists()
        ? Object.values(empSnap.val())[0].fullName
        : 'ไม่ทราบชื่อ';

      document.getElementById('issueActorName').textContent   = borrowerName;
      document.getElementById('receiveActorName').textContent = borrowerName;

      // populate inventoryList
      const dl = document.getElementById('inventoryList');
      stockRef.once('value').then(snap => {
        dl.innerHTML = '';
        snap.forEach(ch => {
          const d = ch.val();
          const opt = document.createElement('option');
          opt.value = `${d.code} ‒ ${d.name}`;
          dl.appendChild(opt);
        });
      });
    };

    // bind inventory info
    function bindInventory(inputId, infoId) {
      document.getElementById(inputId).addEventListener('input', ev => {
        const raw = ev.target.value;
        const id  = raw.includes(' ‒ ') ? raw.split(' ‒ ')[0].trim() : raw.trim();
        if (!id) return;
        stockRef.child(id).get().then(snap => {
          if (!snap.exists()) return showCustomAlert('ไม่พบสินค้า');
          const d = snap.val();
          document.getElementById(infoId).textContent =
            `คงเหลือ: ${d.quantity||0}  หน่วย: ${d.unit||'-'}`;
        });
      });
    }
    bindInventory('issCodeInput','issStockInfo');
    bindInventory('recvCodeInput','recvStockInfo');

    // setup scan
    function setupScan(btnId, videoId, inputId) {
      const canvas = document.createElement('canvas');
      const ctx    = canvas.getContext('2d');
      document.getElementById(btnId).onclick = async () => {
        const video = document.getElementById(videoId);
        const stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:'environment'} });
        video.srcObject = stream; video.play(); video.classList.remove('hidden');
        requestAnimationFrame(function scan(){
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            ctx.drawImage(video,0,0);
            const code = jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data, canvas.width, canvas.height);
            if (code) {
              document.getElementById(inputId).value = code.data.trim();
              document.getElementById(inputId).dispatchEvent(new Event('input'));
              video.srcObject.getTracks().forEach(t=>t.stop());
              video.classList.add('hidden');
              return;
            }
          }
          requestAnimationFrame(scan);
        });
      };
    }
    setupScan('issScanBtn','issVideo','issCodeInput');
    setupScan('recvScanBtn','recvVideo','recvCodeInput');

    // submit issue
    document.getElementById('issSubmit').onclick = async ()=>{
      const code = document.getElementById('issCodeInput').value.split(' ‒ ')[0];
      const qty  = +document.getElementById('issQty').value;
      if (!code) return showCustomAlert('กรุณาเลือกสินค้า');
      if (qty<1) return showCustomAlert('กรุณากรอกจำนวนให้ถูกต้อง');
      const recordId = issueRef.push().key;
      const now      = new Date().toISOString();
      const name     = document.getElementById('issCodeInput').value.split(' ‒ ')[1]||'';
      await issueRef.child(recordId).set({
        id:        recordId,
        date:      now,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        borrower:  borrowerName,
        userId:    userIdLine,
        itemCode:  code,
        itemName:  name,
        quantity:  qty
      });
      await stockRef.child(code).child('quantity').transaction(c=>(c||0)-qty);
      // clear
      document.getElementById('issCodeInput').value = '';
      document.getElementById('issQty').value      = '1';
      document.getElementById('issStockInfo').textContent = 'คงเหลือ: –';
      // send LINE message
      await liff.sendMessages([{ type:'text',
        text:`เบิกสินค้า\nรหัส:${code}\nชื่อ:${name}\nจำนวน:${qty}\nผู้เบิก:${borrowerName}` }]);
      showCustomAlert('เบิกเรียบร้อย');
    };

    // submit receive
    document.getElementById('recvSubmit').onclick = async ()=>{
      const code = document.getElementById('recvCodeInput').value.split(' ‒ ')[0];
      const qty  = +document.getElementById('recvQty').value;
      if (!code) return showCustomAlert('กรุณาเลือกสินค้า');
      if (qty<1) return showCustomAlert('กรุณากรอกจำนวนให้ถูกต้อง');
      const recordId = receiveRef.push().key;
      const now      = new Date().toISOString();
      const name     = document.getElementById('recvCodeInput').value.split(' ‒ ')[1]||'';
      await receiveRef.child(recordId).set({
        id:        recordId,
        date:      now,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        borrower:  borrowerName,
        userId:    userIdLine,
        itemCode:  code,
        itemName:  name,
        quantity:  qty
      });
      await stockRef.child(code).child('quantity').transaction(c=>(c||0)+qty);
      // clear
      document.getElementById('recvCodeInput').value = '';
      document.getElementById('recvQty').value      = '1';
      document.getElementById('recvStockInfo').textContent = 'คงเหลือ: –';
      // send LINE message
      await liff.sendMessages([{ type:'text',
        text:`รับเข้าสินค้า\nรหัส:${code}\nชื่อ:${name}\nจำนวน:${qty}\nผู้รับเข้า:${borrowerName}` }]);
      showCustomAlert('รับเข้าเรียบร้อย');
    };

    // load & render history
    async function loadHistory(){
      const [rSnap,iSnap] = await Promise.all([ receiveRef.once('value'), issueRef.once('value') ]);
      const recs = [];
      rSnap.forEach(ch=>{
        const d=ch.val();
        if(d.userId===userIdLine) recs.push({...d,type:'receive'});
      });
      iSnap.forEach(ch=>{
        const d=ch.val();
        if(d.userId===userIdLine) recs.push({...d,type:'issue'});
      });
      recs.sort((a,b)=>new Date(b.date)-new Date(a.date));
      historyRecords = recs;
      historyPage = 1;
      renderHistory();
    }
    function renderHistory(){
      const start = (historyPage-1)*historyPageSize;
      const page  = historyRecords.slice(start,start+historyPageSize);
      const tbody = document.getElementById('historyTable');
      tbody.innerHTML = '';
      page.forEach(d=>{
        const cls = d.type==='receive'? 'bg-green-50' : 'bg-red-50';
        const tr = document.createElement('tr');
        tr.className = cls;
        tr.innerHTML = `
          <td class="px-4 py-2">${new Date(d.date).toLocaleDateString('th-TH')}</td>
          <td class="px-4 py-2">${d.itemName}</td>
          <td class="px-4 py-2">${d.quantity}</td>`;
        tbody.appendChild(tr);
      });
      const total = Math.ceil(historyRecords.length/historyPageSize) || 1;
      document.getElementById('historyPageInfo').textContent =
        `หน้าที่ ${historyPage} จาก ${total}`;
      document.getElementById('historyPrev').disabled = historyPage===1;
      document.getElementById('historyNext').disabled = historyPage===total;
    }
    document.getElementById('historyPrev').onclick = ()=>{
      if(historyPage>1){ historyPage--; renderHistory(); }
    };
    document.getElementById('historyNext').onclick = ()=>{
      const total = Math.ceil(historyRecords.length/historyPageSize);
      if(historyPage<total){ historyPage++; renderHistory(); }
    };
  </script>
</body>
</html>
