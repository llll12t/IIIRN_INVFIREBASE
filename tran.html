<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (LIFF Mode)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <!-- jsQR for QR scanning -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <!-- Your Firebase config -->
  <script src="firebase-config.js"></script>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

  <!-- Alert -->
  <div id="customAlert"
       class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded shadow hidden z-50"></div>

  <div class="max-w-lg mx-auto p-6 space-y-6">
    <!-- Tabs -->
    <div class="flex mb-4 border-b">
      <button id="tabIssueBtn"
              class="flex-1 py-2 text-center border-b-2 border-primary font-semibold">
        ‡πÄ‡∏ö‡∏¥‡∏Å
      </button>
      <button id="tabReceiveBtn"
              class="flex-1 py-2 text-center border-b-2 border-transparent hover:border-primary">
        ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤
      </button>
      <button id="tabHistoryBtn"
              class="flex-1 py-2 text-center border-b-2 border-transparent hover:border-primary">
        ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
      </button>
    </div>

    <!-- ‡πÄ‡∏ö‡∏¥‡∏Å Form -->
    <div id="tabIssue">
      <div class="bg-white p-4 rounded-lg mb-4">
        <div class="mb-2"><span class="font-bold">‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å:</span> <span id="issueActorName">‚Äì</span></div>
      </div>

      <!-- multi-item container -->
      <datalist id="inventoryList"></datalist>
      <div id="issueItemsContainer" class="space-y-2">
        <div class="item-row flex space-x-2">
          <input list="inventoryList" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" class="flex-2 border rounded p-2 code-input" />
          <input type="number" min="1" value="1" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" class="w-20 border rounded p-2 qty-input" />
          <button type="button" class="remove-item px-2 text-white bg-red-500 rounded">‚Äì</button>
        </div>
      </div>
      <button id="addIssueItem" class="text-sm text-primary hover:underline">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>

      <button id="issSubmit"
              class="w-full mt-4 bg-red-600 hover:bg-red-500 text-white py-2 rounded">
        ‡πÄ‡∏ö‡∏¥‡∏Å (‡∏™‡πà‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
      </button>
    </div>

    <!-- ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ Form (single) -->
    <div id="tabReceive" class="hidden">
      <div class="bg-white p-4 rounded-lg mb-4">
        <div class="mb-2"><span class="font-bold">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤:</span> <span id="receiveActorName">‚Äì</span></div>
      </div>
      <datalist id="inventoryList2"></datalist>
      <input list="inventoryList2" id="recvCodeInput"
             placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
             class="w-full border rounded p-2 mb-2" />
      <button id="recvScanBtn"
              class="w-full mb-4 bg-green-600 hover:bg-green-500 text-white py-2 rounded">
        ‡∏™‡πÅ‡∏Å‡∏ô QR
      </button>
      <video id="recvVideo" playsinline class="w-full h-48 object-cover rounded mb-4 hidden"></video>
      <input id="recvQty" type="number" min="1" value="1"
             placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤" class="w-full border rounded p-2 mb-4" />
      <button id="recvSubmit"
              class="w-full bg-green-600 hover:bg-green-500 text-white py-2 rounded">
        ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤
      </button>
    </div>

    <!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Table -->
    <div id="tabHistory" class="hidden">
      <div class="overflow-x-auto bg-white rounded shadow mb-2">
        <table class="min-w-full text-left">
          <thead class="bg-gray-200">
            <tr>
              <th class="px-4 py-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th class="px-4 py-2">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
              <th class="px-4 py-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
            </tr>
          </thead>
          <tbody id="historyTable" class="divide-y"></tbody>
        </table>
      </div>
      <div class="flex justify-between items-center">
        <button id="historyPrev"
                class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50"
                disabled>‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
        <span id="historyPageInfo" class="text-sm text-gray-600">‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà 1 ‡∏à‡∏≤‡∏Å 1</span>
        <button id="historyNext"
                class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50"
                disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
      </div>
    </div>
  </div>

  <script>
    // === Config ===
    const LIFF_ID = '2007335399-rmoYp9Md';
    const GAS_URL = 'https://script.google.com/macros/s/XXX/exec';

    // Firebase refs
    const stockRef     = db.ref('stock');
    const receiveRef   = db.ref('receiveRecords');
    const issueRef     = db.ref('issueRecords');
    const employeesRef = db.ref('employees');

    let userIdLine = '', borrowerName = '';
    let historyRecords = [], historyPage = 1;
    const historyPageSize = 15;

    // Tab handling
    const tabIssueBtn   = document.getElementById('tabIssueBtn');
    const tabReceiveBtn = document.getElementById('tabReceiveBtn');
    const tabHistoryBtn = document.getElementById('tabHistoryBtn');
    const tabIssue      = document.getElementById('tabIssue');
    const tabReceive    = document.getElementById('tabReceive');
    const tabHistory    = document.getElementById('tabHistory');
    function activateTab(i,r,h){
      tabIssue   .classList.toggle('hidden',!i);
      tabReceive .classList.toggle('hidden',!r);
      tabHistory .classList.toggle('hidden',!h);
      tabIssueBtn   .classList.toggle('border-primary',i);
      tabReceiveBtn .classList.toggle('border-primary',r);
      tabHistoryBtn .classList.toggle('border-primary',h);
    }
    tabIssueBtn  .onclick=()=>activateTab(true,false,false);
    tabReceiveBtn.onclick=()=>activateTab(false,true,false);
    tabHistoryBtn.onclick=()=>{activateTab(false,false,true);loadHistory();};

    function showCustomAlert(msg){
      const a=document.getElementById('customAlert');
      a.textContent=msg; a.classList.remove('hidden');
      setTimeout(()=>a.classList.add('hidden'),3000);
    }

    // LIFF init & load
    window.onload=async()=>{
      await liff.init({liffId:LIFF_ID,withLoginOnExternalBrowser:true});
      if(!liff.isInClient()&&!liff.isLoggedIn()){
        await liff.login({scope:'profile openid chat_message.write'});
        return;
      }
      const profile=await liff.getProfile();
      userIdLine=profile.userId;
      const empSnap=await employeesRef.orderByChild('userIdLine').equalTo(userIdLine).get();
      borrowerName=empSnap.exists()?Object.values(empSnap.val())[0].fullName:'‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠';
      document.getElementById('issueActorName').textContent=borrowerName;
      document.getElementById('receiveActorName').textContent=borrowerName;

      // populate lists
      stockRef.once('value').then(snap=>{
        snap.forEach(ch=>{
          const d=ch.val();
          ['inventoryList','inventoryList2'].forEach(id=>{
            const dl=document.getElementById(id);
            const opt=document.createElement('option');
            opt.value=`${d.code} ‚Äí ${d.name}`;
            dl.appendChild(opt);
          });
        });
      });

      activateTab(true,false,false);
    };

    // bind multi-row remove
    function bindRemoveButtons(){
      document.querySelectorAll('.remove-item').forEach(btn=>{
        btn.onclick=()=>{
          const rows=document.querySelectorAll('.item-row');
          if(rows.length>1) btn.closest('.item-row').remove();
        };
      });
    }
    bindRemoveButtons();

    // add new issue row
    document.getElementById('addIssueItem').onclick=()=>{
      const tmpl=document.querySelector('.item-row');
      const clone=tmpl.cloneNode(true);
      clone.querySelector('.code-input').value='';
      clone.querySelector('.qty-input').value='1';
      document.getElementById('issueItemsContainer').appendChild(clone);
      bindRemoveButtons();
      bindInventory(clone.querySelector('.code-input'),null,null,null);
    };

    // bind single inventory lookup (used also for dynamic rows)
    function bindInventory(input,_,__,___){
      input.addEventListener('input',async ev=>{
        const raw=ev.target.value;
        const code=raw.includes(' ‚Äí ')?raw.split(' ‚Äí ')[0].trim():raw.trim();
        if(!code)return;
        const snap=await stockRef.child(code).get();
        if(!snap.exists()){showCustomAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');return;}
      });
    }
    // initial bind
    document.querySelectorAll('.code-input').forEach(i=>bindInventory(i));

    // fetch admin IDs
    async function getAdminIds(){
      const snap=await employeesRef.orderByChild('role').equalTo('admin').get();
      const ids=[]; snap.forEach(ch=>{
        const u=ch.val().userIdLine; if(u)ids.push(u);
      });
      return ids;
    }

    // notify via GAS
    async function notifyAdmins(action, items){
      const admins=await getAdminIds();
      if(!admins.length)return;
      fetch(GAS_URL,{
        method:'POST',
        mode:'no-cors',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          action,
          user: borrowerName,
          userId: userIdLine,
          date: new Date().toISOString(),
          items,
          toList: admins
        })
      });
    }

    // submit multi-issue
    document.getElementById('issSubmit').onclick=async()=>{
      const rows=document.querySelectorAll('.item-row');
      const items=[];
      for(const row of rows){
        const raw=row.querySelector('.code-input').value;
        const code=raw.split(' ‚Äí ')[0].trim();
        const qty=+row.querySelector('.qty-input').value;
        if(!code||qty<1)return showCustomAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
        const snap=await stockRef.child(code).get();
        const avail=snap.val().quantity||0;
        if(qty>avail) return showCustomAlert(`‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô ${code}`);
        items.push({ code, name:snap.val().name, qty });
      }
      const now=new Date().toISOString();
      for(const it of items){
        const id=issueRef.push().key;
        await issueRef.child(id).set({
          id, date: now,
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          borrower: borrowerName,
          userId: userIdLine,
          itemCode: it.code,
          itemName: it.name,
          quantity: it.qty
        });
        await stockRef.child(it.code).child('quantity').transaction(c=>c-it.qty);
      }
      // liff message summary
      const summary=items.map(it=>`${it.code}(${it.qty})`).join('\n');
      await liff.sendMessages([{type:'text',text:`üì§ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n${summary}`}]);
      await notifyAdmins('issue-multi', items);
      // reset rows to one
      document.getElementById('issueItemsContainer').innerHTML='';
      document.getElementById('addIssueItem').click();
      showCustomAlert('‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    };

    // single receive (unchanged)
    // ... (reuse your existing receive logic) ...

    // load & render history
    async function loadHistory(){
      const [rSnap,iSnap]=await Promise.all([
        receiveRef.once('value'),
        issueRef.once('value')
      ]);
      const recs=[];
      rSnap.forEach(ch=>{const d=ch.val(); if(d.userId===userIdLine) recs.push({...d,type:'receive'});});
      iSnap.forEach(ch=>{const d=ch.val(); if(d.userId===userIdLine) recs.push({...d,type:'issue'});});
      recs.sort((a,b)=>new Date(b.date)-new Date(a.date));
      historyRecords=recs; historyPage=1; renderHistory();
    }
    function renderHistory(){
      const start=(historyPage-1)*historyPageSize;
      const page=historyRecords.slice(start,start+historyPageSize);
      const tbody=document.getElementById('historyTable'); tbody.innerHTML='';
      page.forEach(d=>{
        const cls=d.type==='receive'?'bg-green-50':'bg-red-50';
        const tr=document.createElement('tr'); tr.className=cls;
        tr.innerHTML=`
          <td class="px-4 py-2">${new Date(d.date).toLocaleString('th-TH')}</td>
          <td class="px-4 py-2">${d.itemName}</td>
          <td class="px-4 py-2">${d.quantity}</td>`;
        tbody.appendChild(tr);
      });
      const total=Math.max(1,Math.ceil(historyRecords.length/historyPageSize));
      document.getElementById('historyPageInfo').textContent=`‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ${historyPage} ‡∏à‡∏≤‡∏Å ${total}`;
      document.getElementById('historyPrev').disabled=historyPage===1;
      document.getElementById('historyNext').disabled=historyPage===total;
    }
    document.getElementById('historyPrev').onclick=()=>{if(historyPage>1){historyPage--;renderHistory();}};
    document.getElementById('historyNext').onclick=()=>{const t=Math.ceil(historyRecords.length/historyPageSize); if(historyPage<t){historyPage++;renderHistory();}};
  </script>
</body>
</html>
