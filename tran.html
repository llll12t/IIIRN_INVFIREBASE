<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ระบบคลังสินค้าอัจฉริยะ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <!-- IMPORTANT: Make sure your firebase-config.js is in the same directory and configured correctly -->
  <script src="firebase-config.js"></script>

  <script>
    // Tailwind CSS Configuration
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              light: '#60A5FA',
              DEFAULT: '#3B82F6',
              dark: '#2563EB',
            },
            secondary: {
              light: '#A78BFA',
              DEFAULT: '#8B5CF6',
              dark: '#7C3AED',
            }
          },
          fontFamily: {
            sans: ['Sukhumvit Set', 'Kanit', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <style>
    #customAlert {
      transition: all 0.3s ease-in-out;
      transform: translateX(100%);
      opacity: 0;
    }
    #customAlert.show {
      transform: translateX(0);
      opacity: 1;
    }
    #customAlert.success {
      background-color: #10B981; /* Green-500 */
    }
    #customAlert.error {
      background-color: #EF4444; /* Red-500 */
    }
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #fff;
      border-radius: 50%;
      width: 1.5rem;
      height: 1.5rem;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .tab-button.active {
      border-color: var(--tw-colors-primary-DEFAULT);
      color: var(--tw-colors-primary-DEFAULT);
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

  <!-- Custom Alert Notification -->
  <div id="customAlert"
       class="fixed top-6 right-6 w-fit max-w-sm text-white px-5 py-3 rounded-lg shadow-xl text-center z-50 flex items-center justify-center space-x-2">
    <svg id="alertIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
      <!-- Icon will be dynamically updated -->
    </svg>
    <span id="alertMessage"></span>
  </div>

  <div class="w-full max-w-lg mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
    <!-- Tabs -->
    <div class="flex border-b border-gray-200 bg-gray-50">
      <button id="tabIssueBtn"   class="tab-button flex-1 py-3 text-center border-b-2 border-primary active font-semibold text-primary transition-colors duration-200">เบิก</button>
      <button id="tabReceiveBtn" class="tab-button flex-1 py-3 text-center border-b-2 border-transparent text-gray-600 hover:text-primary hover:border-primary transition-colors duration-200">รับเข้า</button>
      <button id="tabHistoryBtn" class="tab-button flex-1 py-3 text-center border-b-2 border-transparent text-gray-600 hover:text-primary hover:border-primary transition-colors duration-200">ประวัติ</button>
    </div>

    <div class="p-6 space-y-6">
      <!-- เบิก (หลายรายการ) -->
      <div id="tabIssue">
        <div class="text-center mb-6">
          <h2 class="text-2xl font-extrabold text-gray-800">เบิกสินค้าหลายรายการ</h2>
          <p class="text-gray-600 mt-2">ผู้เบิก: <span id="actorIssue" class="font-semibold text-primary">–</span></p>
        </div>

        <button id="scanIssueBtn" class="w-full mb-4 bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 flex items-center justify-center space-x-2">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
          <span>สแกน QR เพื่อเพิ่มรายการ</span>
        </button>

        <div id="videoIssueContainer" class="relative w-full h-48 bg-gray-200 rounded-lg overflow-hidden hidden mb-4">
          <video id="videoIssue" playsinline class="w-full h-full object-cover"></video>
          <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 text-white text-lg font-bold">
            วาง QR Code ในกรอบ
          </div>
        </div>

        <datalist id="inventoryList"></datalist>
        <ul id="basketIssue" class="space-y-3 mb-4"></ul>

        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 mb-6">
          <input list="inventoryList" id="manualCodeIssue" placeholder="รหัสหรือชื่อสินค้า" class="flex-1 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-primary-light focus:border-primary-light transition-all duration-200" />
          <input type="number" id="manualQtyIssue" min="1" value="1" class="w-full sm:w-24 border border-gray-300 rounded-lg p-3 text-center focus:ring-2 focus:ring-primary-light focus:border-primary-light transition-all duration-200" />
          <button id="addIssueBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
            เพิ่ม
          </button>
        </div>

        <button id="submitIssueBtn" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 flex items-center justify-center disabled:opacity-50 disabled:pointer-events-none" disabled>
          <span id="issueBtnText">ยืนยันเบิก (หลายรายการ)</span>
          <span id="issueBtnSpinner" class="spinner ml-2 hidden"></span>
        </button>
      </div>

      <!-- รับเข้า (หลายรายการ) -->
      <div id="tabReceive" class="hidden">
        <div class="text-center mb-6">
          <h2 class="text-2xl font-extrabold text-gray-800">รับเข้าสินค้าหลายรายการ</h2>
          <p class="text-gray-600 mt-2">ผู้รับเข้า: <span id="actorReceive" class="font-semibold text-primary">–</span></p>
        </div>

        <button id="scanReceiveBtn" class="w-full mb-4 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 flex items-center justify-center space-x-2">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
          <span>สแกน QR เพื่อเพิ่มรายการ</span>
        </button>

        <div id="videoReceiveContainer" class="relative w-full h-48 bg-gray-200 rounded-lg overflow-hidden hidden mb-4">
          <video id="videoReceive" playsinline class="w-full h-full object-cover"></video>
          <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 text-white text-lg font-bold">
            วาง QR Code ในกรอบ
          </div>
        </div>

        <datalist id="inventoryList2"></datalist>
        <ul id="basketReceive" class="space-y-3 mb-4"></ul>

        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 mb-6">
          <input list="inventoryList2" id="manualCodeReceive" placeholder="รหัสหรือชื่อสินค้า" class="flex-1 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-primary-light focus:border-primary-light transition-all duration-200" />
          <input type="number" id="manualQtyReceive" min="1" value="1" class="w-full sm:w-24 border border-gray-300 rounded-lg p-3 text-center focus:ring-2 focus:ring-primary-light focus:border-primary-light transition-all duration-200" />
          <button id="addReceiveBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
            เพิ่ม
          </button>
        </div>

        <button id="submitReceiveBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 flex items-center justify-center disabled:opacity-50 disabled:pointer-events-none" disabled>
          <span id="receiveBtnText">ยืนยันรับเข้า (หลายรายการ)</span>
          <span id="receiveBtnSpinner" class="spinner ml-2 hidden"></span>
        </button>
      </div>

      <!-- ประวัติ -->
      <div id="tabHistory" class="hidden">
        <div class="text-center mb-6">
          <h2 class="text-2xl font-extrabold text-gray-800">ประวัติการทำรายการ</h2>
          <p class="text-gray-600 mt-2">รายการล่าสุดของคุณ</p>
        </div>
        <div class="overflow-x-auto bg-white rounded-lg shadow-md mb-4 border border-gray-200">
          <table class="min-w-full text-left">
            <thead class="bg-gray-100 border-b border-gray-200">
              <tr>
                <th class="px-4 py-3 text-sm font-semibold text-gray-700">วันที่/เวลา</th>
                <th class="px-4 py-3 text-sm font-semibold text-gray-700">ประเภท</th>
                <th class="px-4 py-3 text-sm font-semibold text-gray-700">รหัส-ชื่อ</th>
                <th class="px-4 py-3 text-sm font-semibold text-gray-700">จำนวน</th>
              </tr>
            </thead>
            <tbody id="historyTable" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
        <div class="flex justify-between items-center px-2 py-2">
          <button id="historyPrev" class="px-5 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors duration-200 disabled:opacity-50 disabled:pointer-events-none" disabled>
            <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            ก่อนหน้า
          </button>
          <span id="historyPageInfo" class="text-sm text-gray-600 font-medium">หน้าที่ 1 จาก 1</span>
          <button id="historyNext" class="px-5 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors duration-200 disabled:opacity-50 disabled:pointer-events-none" disabled>
            ถัดไป
            <svg class="w-4 h-4 inline-block ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration constants
    const LIFF_ID       = '2007335399-rmoYp9Md'; // <<<--- YOUR LIFF ID
    const GAS_URL       = 'https://script.google.com/macros/s/AKfycbz-x6XGsMhuhkWOlBh8NAoVuiOopCXZdqJ_G3lyiUW5pq0TOGJToiqxHM2Rsit2xSVB/exec'; // <<<--- YOUR GAS URL
    
    // Firebase references
    const stockRef      = db.ref('stock');
    const issueRef      = db.ref('issueRecords');
    const receiveRef    = db.ref('receiveRecords');
    const employeesRef  = db.ref('employees');

    // Global state variables
    let userIdLine      = '';
    let actorIssue      = '';
    let actorReceive    = '';
    let basketIssue     = [];
    let basketReceive   = [];
    let historyRecords  = [];
    let historyPage     = 1;
    const pageSize      = 15;

    // --- UI Helper Functions ---
    const customAlert = document.getElementById('customAlert');
    const alertMessage = document.getElementById('alertMessage');
    const alertIcon = document.getElementById('alertIcon');

    function showAlert(msg, type = 'error'){
      alertMessage.textContent = msg;
      customAlert.classList.remove('success', 'error');
      customAlert.classList.add(type);

      if (type === 'success') {
        alertIcon.innerHTML = `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>`;
      } else {
        alertIcon.innerHTML = `<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>`;
      }

      customAlert.classList.add('show');
      setTimeout(() => customAlert.classList.remove('show'), 3000);
    }

    function setButtonLoading(buttonId, isLoading, originalText) {
        const button = document.getElementById(buttonId);
        const baseId = buttonId.replace('submit', '');
        const idPrefix = baseId.charAt(0).toLowerCase() + baseId.slice(1, -3);
        const btnText = document.getElementById(`${idPrefix}BtnText`);
        const btnSpinner = document.getElementById(`${idPrefix}BtnSpinner`);

        if (!button || !btnText || !btnSpinner) {
            console.error(`Could not find elements for buttonId: ${buttonId}`);
            return;
        }

        if (isLoading) {
            button.disabled = true;
            btnText.textContent = 'กำลังส่ง...';
            btnSpinner.classList.remove('hidden');
        } else {
            button.disabled = false;
            btnText.textContent = originalText;
            btnSpinner.classList.add('hidden');
        }
    }
    
    /**
     * [MODIFIED] Updates basket UI. Shows stock balance for issue basket.
     */
    function updateBasket(listId, basket, btnId) {
        const basketElement = document.getElementById(listId);
        basketElement.innerHTML = basket.map(it => {
            const stockInfo = listId === 'basketIssue'
                ? `<span class="text-xs text-gray-500">(คงเหลือ: ${it.stockQty ?? 'N/A'})</span>`
                : '';

            return `
            <li class="flex justify-between items-center bg-gray-50 p-3 rounded-lg shadow-sm border border-gray-100">
                <div class="flex-grow">
                    <span class="text-sm font-medium text-gray-800">${it.code}</span>
                    <div class="flex items-baseline justify-between pr-2">
                        <span class="block text-md text-gray-700">${it.name} × <span class="font-bold">${it.qty}</span></span>
                        ${stockInfo}
                    </div>
                </div>
                <button onclick="removeFromBasket('${listId}','${it.code}','${btnId}')" class="text-red-500 text-lg font-bold hover:text-red-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-300 rounded-full px-2 ml-2 flex-shrink-0">
                ×
                </button>
            </li>`;
        }).join('');
        document.getElementById(btnId).disabled = basket.length === 0;
    }

    window.removeFromBasket = (listId, code, btnId) => {
      if(listId==='basketIssue') {
        basketIssue = basketIssue.filter(x => x.code !== code);
        updateBasket('basketIssue', basketIssue, 'submitIssueBtn');
      } else {
        basketReceive = basketReceive.filter(x => x.code !== code);
        updateBasket('basketReceive', basketReceive, 'submitReceiveBtn');
      }
      showAlert('นำสินค้าออกจากตะกร้าแล้ว', 'success');
    };

    async function liffInit(){
      try {
        await liff.init({ liffId: LIFF_ID });
        if(!liff.isLoggedIn()) {
          await liff.login();
        }
        const prof = await liff.getProfile();
        userIdLine = prof.userId;

        const snapIssue = await employeesRef.orderByChild('userIdLine').equalTo(userIdLine).get();
        actorIssue   = snapIssue.exists()? Object.values(snapIssue.val())[0].fullName : 'ไม่ทราบชื่อ';
        actorReceive = actorIssue; 

        document.getElementById('actorIssue').textContent   = actorIssue;
        document.getElementById('actorReceive').textContent = actorReceive;

        const snapStock = await stockRef.once('value');
        snapStock.forEach(ch=>{
          const d = ch.val();
          ['inventoryList','inventoryList2'].forEach(id=>{
            document.getElementById(id).insertAdjacentHTML('beforeend',`<option value="${d.code} ‒ ${d.name}">`);
          });
        });
      } catch (err) {
        console.error("LIFF initialization failed: ", err);
        showAlert('เกิดข้อผิดพลาดในการเริ่มต้น LIFF: ' + err.message);
      }
    }

    function setupScan(btnId, videoId, containerId, listKey){
      document.getElementById(btnId).onclick = async ()=>{
        const video = document.getElementById(videoId);
        const videoContainer = document.getElementById(containerId);
        let stream = null;

        try {
          stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:'environment'} });
          video.srcObject = stream;
          video.play();
          videoContainer.classList.remove('hidden');

          const canvas=document.createElement('canvas');
          const ctx=canvas.getContext('2d');

          function scan(){
            if(video.readyState===video.HAVE_ENOUGH_DATA){
              canvas.width=video.videoWidth;
              canvas.height=video.videoHeight;
              ctx.drawImage(video,0,0);
              const code=jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data,canvas.width,canvas.height);
              if(code){
                addToBasket(listKey,code.data.trim(), 1); // QR scan always adds 1
                stream.getTracks().forEach(t=>t.stop());
                videoContainer.classList.add('hidden');
                // showAlert('สแกนสำเร็จ!', 'success'); // addToBasket will show its own alert
                return;
              }
            }
            requestAnimationFrame(scan);
          }
          scan();
        } catch (err) {
          console.error("Camera access error: ", err);
          showAlert('ไม่สามารถเข้าถึงกล้องได้ โปรดตรวจสอบสิทธิ์การเข้าถึง');
          if (stream) stream.getTracks().forEach(t=>t.stop());
          videoContainer.classList.add('hidden');
        }
      };
    }
    setupScan('scanIssueBtn','videoIssue','videoIssueContainer','issue');
    setupScan('scanReceiveBtn','videoReceive','videoReceiveContainer','receive');

    /**
     * [MODIFIED] Adds item to basket with stock checks for 'issue'.
     */
    async function addToBasket(key, code, qty = 1) {
        const snap = await stockRef.child(code).get();
        if (!snap.exists()) {
            return showAlert(`ไม่พบสินค้า "${code}"`, 'error');
        }
        const d = snap.val();
        const stockQty = d.quantity || 0;

        if (key === 'issue') {
            const existingItem = basketIssue.find(x => x.code === code);
            const qtyInBasket = existingItem ? existingItem.qty : 0;
            const newTotalQty = qtyInBasket + qty;

            if (stockQty <= 0) {
                 return showAlert(`สินค้า "${d.name}" หมดสต็อกแล้ว`, 'error');
            }
            if (newTotalQty > stockQty) {
                return showAlert(`เบิกเกิน! "${d.name}" มีคงเหลือ ${stockQty} ชิ้น`, 'error');
            }
            
            if (existingItem) {
                existingItem.qty = newTotalQty;
                existingItem.stockQty = stockQty;
                showAlert(`เพิ่มจำนวน "${d.name}" ในตะกร้า`, 'success');
            } else {
                basketIssue.push({ code, name: d.name, qty, stockQty });
                showAlert(`เพิ่ม "${d.name}" เข้าตะกร้า`, 'success');
            }
            updateBasket('basketIssue', basketIssue, 'submitIssueBtn');

        } else { // 'receive' logic
            const existingItem = basketReceive.find(x => x.code === code);
            if (existingItem) {
                existingItem.qty += qty;
                showAlert(`เพิ่มจำนวน "${d.name}" ในตะกร้า`, 'success');
            } else {
                basketReceive.push({ code, name: d.name, qty });
                showAlert(`เพิ่ม "${d.name}" เข้าตะกร้า`, 'success');
            }
            updateBasket('basketReceive', basketReceive, 'submitReceiveBtn');
        }
    }

    /**
     * [MODIFIED] Handles manual add to issue basket with stock checks.
     */
    document.getElementById('addIssueBtn').onclick = async () => {
      const raw = document.getElementById('manualCodeIssue').value.trim();
      const code = raw.split(' ‒ ')[0];
      const qty = +document.getElementById('manualQtyIssue').value;

      if(!code || qty < 1) {
        return showAlert('กรุณาระบุรหัสและจำนวนให้ถูกต้อง');
      }

      const snap = await stockRef.child(code).get();
      if(!snap.exists()) {
        return showAlert(`ไม่พบสินค้า "${code}"`, 'error');
      }
      const d = snap.val();
      const stockQty = d.quantity || 0;

      // The critical check
      if (qty > stockQty) {
        return showAlert(`เบิกเกิน! "${d.name}" เหลือ ${stockQty} ชิ้น`, 'error');
      }
      
      const existingItem = basketIssue.find(x => x.code === code);
      if (existingItem) {
        existingItem.qty = qty; // Update quantity
        existingItem.stockQty = stockQty;
        showAlert(`อัปเดตจำนวน "${d.name}" เป็น ${qty} ชิ้น`, 'success');
      } else {
        basketIssue.push({ code, name: d.name, qty, stockQty });
        showAlert(`เพิ่ม "${d.name}" จำนวน ${qty} ชิ้น`, 'success');
      }

      updateBasket('basketIssue', basketIssue, 'submitIssueBtn');
      document.getElementById('manualCodeIssue').value = '';
      document.getElementById('manualQtyIssue').value = '1';
    };

    document.getElementById('addReceiveBtn').onclick = async () => {
      const raw = document.getElementById('manualCodeReceive').value.trim();
      const code = raw.split(' ‒ ')[0];
      const qty = +document.getElementById('manualQtyReceive').value;

      if(!code || qty < 1) {
        return showAlert('กรุณาระบุรหัสและจำนวนให้ถูกต้อง');
      }
      const snap = await stockRef.child(code).get();
      if(!snap.exists()) {
        return showAlert(`ไม่พบสินค้า "${code}"`, 'error');
      }
      const d = snap.val();
      const existingItem = basketReceive.find(x => x.code === code);

      if (existingItem) {
        existingItem.qty = qty;
        showAlert(`อัปเดตจำนวน "${d.name}" เป็น ${qty} ชิ้น`, 'success');
      } else {
        basketReceive.push({ code, name: d.name, qty });
        showAlert(`เพิ่ม "${d.name}" จำนวน ${qty} ชิ้น`, 'success');
      }
      updateBasket('basketReceive', basketReceive, 'submitReceiveBtn');
      document.getElementById('manualCodeReceive').value = '';
      document.getElementById('manualQtyReceive').value = '1';
    };

    async function getAdminIds(){
      const snap=await employeesRef.orderByChild('role').equalTo('admin').get();
      const ids=[]; snap.forEach(ch=>{ const u=ch.val().userIdLine; if(u)ids.push(u); });
      return ids;
    }

    async function notifyAdmins(action, items){
      const toList = await getAdminIds();
      if(!toList.length) {
        console.warn('No admin IDs found for notification.');
        return;
      }
      const simplifiedItems = items.map(item => ({ code: item.code, name: item.name, qty: item.qty }));
      try {
        await fetch(GAS_URL,{
          method:'POST',
          mode:'no-cors',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ action, user: (action === 'issue' ? actorIssue : actorReceive), userId: userIdLine, date: new Date().toISOString(), items: simplifiedItems, toList })
        });
        console.log('Admin notification sent via GAS.');
      } catch (error) {
        console.error('Error sending admin notification via GAS:', error);
      }
    }
    
    /**
     * [NEW] Creates a Flex Message for transaction notifications.
     */
    function createTransactionFlexMessage(action, actor, items) {
        const isIssue = action === 'issue';
        const headerText = isIssue ? 'แจ้งเบิกสินค้า' : 'แจ้งรับเข้าสินค้า';
        const headerColor = isIssue ? '#DC2626' : '#16A34A'; // Red-600 for issue, Green-600 for receive

        const itemComponents = items.map(item => ({
            "type": "box", "layout": "horizontal", "margin": "md", "contents": [
                { "type": "text", "text": `${item.name}`, "wrap": true, "size": "sm", "color": "#555555", "flex": 4 },
                { "type": "text", "text": `x ${item.qty}`, "size": "sm", "color": "#111111", "align": "end", "flex": 1, "weight": "bold" }
            ]
        }));

        return { "type": "flex", "altText": `[${headerText}] โดย ${actor}`, "contents": {
            "type": "bubble", "size": "giga", "header": {
                "type": "box", "layout": "vertical", "backgroundColor": headerColor, "paddingAll": "12px", "contents": [
                    { "type": "text", "text": headerText, "color": "#FFFFFF", "size": "md", "weight": "bold" }
                ]
            },
            "body": { "type": "box", "layout": "vertical", "spacing": "md", "contents": [
                    { "type": "text", "text": "สรุปรายการ", "weight": "bold", "size": "xl" },
                    { "type": "box", "layout": "vertical", "margin": "lg", "spacing": "sm", "contents": [
                        { "type": "box", "layout": "baseline", "spacing": "sm", "contents": [
                            { "type": "text", "text": "ผู้ทำรายการ", "color": "#aaaaaa", "size": "sm", "flex": 3 },
                            { "type": "text", "text": actor, "wrap": true, "color": "#666666", "size": "sm", "flex": 5 }
                        ]},
                        { "type": "box", "layout": "baseline", "spacing": "sm", "contents": [
                            { "type": "text", "text": "วันที่/เวลา", "color": "#aaaaaa", "size": "sm", "flex": 3 },
                            { "type": "text", "text": new Date().toLocaleString('th-TH'), "wrap": true, "color": "#666666", "size": "sm", "flex": 5 }
                        ]}
                    ]},
                    { "type": "separator", "margin": "xxl" },
                    ...itemComponents,
                    { "type": "separator", "margin": "xxl" }
                ]
            }
        }};
    }

    /**
     * [MODIFIED] Handles submission of issue items with final validation and Flex message.
     */
    document.getElementById('submitIssueBtn').onclick = async ()=>{
      if(!basketIssue.length) return;
      setButtonLoading('submitIssueBtn', true, 'ยืนยันเบิก (หลายรายการ)');
      try {
        // Final validation before submission
        for (const item of basketIssue) {
            const stockSnap = await stockRef.child(item.code).child('quantity').get();
            const currentStock = stockSnap.val() || 0;
            if (item.qty > currentStock) {
                showAlert(`เบิกเกิน! "${item.name}" มีเหลือแค่ ${currentStock} ชิ้น`, 'error');
                item.stockQty = currentStock; // Update UI with correct stock
                updateBasket('basketIssue', basketIssue, 'submitIssueBtn');
                setButtonLoading('submitIssueBtn', false, 'ยืนยันเบิก (หลายรายการ)');
                return; // Stop submission
            }
        }
        
        const now = new Date().toISOString();
        const itemsToProcess = [...basketIssue];

        for(const it of itemsToProcess){
          const key=issueRef.push().key;
          await issueRef.child(key).set({ id:key, date:now, timestamp:firebase.database.ServerValue.TIMESTAMP, borrower:actorIssue, userId:userIdLine, itemCode:it.code, itemName:it.name, quantity:it.qty });
          await stockRef.child(it.code).child('quantity').transaction(c => (c || 0) - it.qty);
        }

        const flexMessage = createTransactionFlexMessage('issue', actorIssue, itemsToProcess);
        await liff.sendMessages([flexMessage]);
        
        await notifyAdmins('issue', itemsToProcess);
        showAlert('เบิกสินค้าเรียบร้อยแล้ว', 'success');
        basketIssue = [];
        updateBasket('basketIssue', [], 'submitIssueBtn');
      } catch (error) {
        console.error("Error submitting issue: ", error);
        showAlert('เกิดข้อผิดพลาดในการเบิกสินค้า: ' + error.message);
      } finally {
        setButtonLoading('submitIssueBtn', false, 'ยืนยันเบิก (หลายรายการ)');
      }
    };

    /**
     * [MODIFIED] Handles submission of receive items with Flex message.
     */
    document.getElementById('submitReceiveBtn').onclick = async ()=>{
      if(!basketReceive.length) return;
      setButtonLoading('submitReceiveBtn', true, 'ยืนยันรับเข้า (หลายรายการ)');
      try {
        const now = new Date().toISOString();
        const itemsToProcess = [...basketReceive];

        for(const it of itemsToProcess){
          const key=receiveRef.push().key;
          await receiveRef.child(key).set({ id:key, date:now, timestamp:firebase.database.ServerValue.TIMESTAMP, borrower:actorReceive, userId:userIdLine, itemCode:it.code, itemName:it.name, quantity:it.qty });
          await stockRef.child(it.code).child('quantity').transaction(c=> (c || 0) + it.qty);
        }

        const flexMessage = createTransactionFlexMessage('receive', actorReceive, itemsToProcess);
        await liff.sendMessages([flexMessage]);

        await notifyAdmins('receive', itemsToProcess);
        showAlert('รับเข้าสินค้าเรียบร้อยแล้ว', 'success');
        basketReceive = [];
        updateBasket('basketReceive', [], 'submitReceiveBtn');
      } catch (error) {
        console.error("Error submitting receive: ", error);
        showAlert('เกิดข้อผิดพลาดในการรับเข้าสินค้า: ' + error.message);
      } finally {
        setButtonLoading('submitReceiveBtn', false, 'ยืนยันรับเข้า (หลายรายการ)');
      }
    };

    async function loadHistory(){
      try {
        const [rSnap,iSnap]=await Promise.all([receiveRef.once('value'),issueRef.once('value')]);
        const recs=[];
        rSnap.forEach(ch=>{const d=ch.val(); if(d.userId===userIdLine) recs.push({...d,type:'receive'});});
        iSnap.forEach(ch=>{const d=ch.val(); if(d.userId===userIdLine) recs.push({...d,type:'issue'});});
        recs.sort((a,b)=> (new Date(b.timestamp || b.date)).getTime() - (new Date(a.timestamp || a.date)).getTime());
        historyRecords=recs; historyPage=1; renderHistory();
      } catch (error) {
        console.error("Error loading history: ", error);
        showAlert('ไม่สามารถโหลดประวัติได้: ' + error.message);
      }
    }

    function renderHistory(){
      const start=(historyPage-1)*pageSize;
      const page=historyRecords.slice(start,start+pageSize);
      const tbody=document.getElementById('historyTable');
      tbody.innerHTML='';
      
      if (page.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="px-4 py-3 text-center text-gray-500">ไม่พบประวัติการทำรายการ</td></tr>`;
      } else {
        page.forEach(d=>{
          const cls=d.type==='receive'?'bg-green-50':'bg-red-50';
          const tr=document.createElement('tr'); tr.className=`${cls} hover:bg-gray-100 transition-colors duration-150`;
          const displayDate = new Date(d.timestamp || d.date).toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'short' });
          tr.innerHTML=`
            <td class="px-4 py-3 text-sm">${displayDate}</td>
            <td class="px-4 py-3 text-sm font-medium ${d.type==='receive'?'text-green-700':'text-red-700'}">${d.type==='receive'?'รับเข้า':'เบิก'}</td>
            <td class="px-4 py-3 text-sm text-gray-800">${d.itemCode} ‒ ${d.itemName}</td>
            <td class="px-4 py-3 text-sm font-bold text-gray-800">${d.quantity}</td>`;
          tbody.appendChild(tr);
        });
      }

      const total=Math.max(1,Math.ceil(historyRecords.length/pageSize));
      document.getElementById('historyPageInfo').textContent=`หน้าที่ ${historyPage} จาก ${total}`;
      document.getElementById('historyPrev').disabled = historyPage===1;
      document.getElementById('historyNext').disabled = historyPage===total;
    }

    document.getElementById('historyPrev').onclick=()=>{if(historyPage>1){historyPage--;renderHistory();}};
    document.getElementById('historyNext').onclick=()=>{const t=Math.ceil(historyRecords.length/pageSize);if(historyPage<t){historyPage++;renderHistory();}};
    
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('#tabIssue, #tabReceive, #tabHistory');

    function activateTab(tabName){
      tabButtons.forEach(btn => {
        btn.classList.remove('active', 'border-primary', 'text-primary', 'font-semibold');
        btn.classList.add('border-transparent', 'text-gray-600');
      });
      tabContents.forEach(content => content.classList.add('hidden'));

      if (tabName === 'issue') {
        document.getElementById('tabIssue').classList.remove('hidden');
        document.getElementById('tabIssueBtn').classList.add('active', 'border-primary', 'text-primary', 'font-semibold');
        document.getElementById('tabIssueBtn').classList.remove('border-transparent', 'text-gray-600');
      } else if (tabName === 'receive') {
        document.getElementById('tabReceive').classList.remove('hidden');
        document.getElementById('tabReceiveBtn').classList.add('active', 'border-primary', 'text-primary', 'font-semibold');
        document.getElementById('tabReceiveBtn').classList.remove('border-transparent', 'text-gray-600');
      } else if (tabName === 'history') {
        document.getElementById('tabHistory').classList.remove('hidden');
        document.getElementById('tabHistoryBtn').classList.add('active', 'border-primary', 'text-primary', 'font-semibold');
        document.getElementById('tabHistoryBtn').classList.remove('border-transparent', 'text-gray-600');
        loadHistory();
      }
    }

    document.getElementById('tabIssueBtn').onclick   = ()=>activateTab('issue');
    document.getElementById('tabReceiveBtn').onclick = ()=>activateTab('receive');
    document.getElementById('tabHistoryBtn').onclick = ()=>activateTab('history');

    liffInit().then(() => activateTab('issue'));
  </script>
</body>
</html>
