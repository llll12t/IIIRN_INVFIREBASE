<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ระบบคลังสินค้า (LIFF + QR + Notify)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <!-- jsQR for QR scanning -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <!-- Your Firebase config -->
  <script src="firebase-config.js"></script>
  <!-- Your Firebase config -->
  <script>
    const firebaseConfig = {
      apiKey: "...",
      authDomain: "...",
      databaseURL: "...",
      projectId: "...",
      storageBucket: "...", // e.g. your-app.appspot.com
      messagingSenderId: "...",
      appId: "...",
      measurementId: "..."
    };
    firebase.initializeApp(firebaseConfig);
  </script>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

  <!-- Alert -->
  <div id="customAlert"
       class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded shadow hidden z-50"></div>

  <div class="max-w-lg mx-auto p-6 space-y-6">
    <!-- Tabs -->
    <div class="flex mb-4 border-b">
      <button id="tabIssueBtn"
              class="flex-1 py-2 text-center border-b-2 border-primary font-semibold">
        เบิก
      </button>
      <button id="tabReceiveBtn"
              class="flex-1 py-2 text-center border-b-2 border-transparent hover:border-primary">
        รับเข้า
      </button>
      <button id="tabHistoryBtn"
              class="flex-1 py-2 text-center border-b-2 border-transparent hover:border-primary">
        ประวัติ
      </button>
    </div>

    <!-- เบิก Form -->
    <div id="tabIssue">
      <div class="bg-white p-4 rounded-lg mb-4">
        <div class="mb-2"><span class="font-bold">ผู้เบิก:</span> <span id="issueActorName">–</span></div>
      </div>

      <button id="issScanBtn"
              class="w-full mb-4 bg-red-600 hover:bg-red-500 text-white py-2 rounded">
        สแกน QR เพิ่มรายการ
      </button>
      <video id="issVideo" playsinline class="w-full h-48 object-cover rounded mb-4 hidden"></video>

      <datalist id="inventoryList"></datalist>
      <div id="issueItemsContainer" class="space-y-2">
        <div class="item-row flex space-x-2">
          <input list="inventoryList" placeholder="รหัสหรือชื่อสินค้า"
                 class="flex-2 border rounded p-2 code-input" />
          <input type="number" min="1" value="1"
                 class="w-20 border rounded p-2 qty-input" />
          <button type="button" class="remove-item px-2 text-white bg-red-500 rounded">–</button>
        </div>
      </div>
      <button id="addIssueItem" class="text-sm text-primary hover:underline">+ เพิ่มรายการ</button>

      <button id="issSubmit"
              class="w-full mt-4 bg-red-600 hover:bg-red-500 text-white py-2 rounded">
        เบิก (ส่งหลายรายการ)
      </button>
    </div>

    <!-- รับเข้า Form -->
    <div id="tabReceive" class="hidden">
      <div class="bg-white p-4 rounded-lg mb-4">
        <div class="mb-2"><span class="font-bold">ผู้รับเข้า:</span> <span id="receiveActorName">–</span></div>
      </div>

      <button id="recvScanBtn"
              class="w-full mb-2 bg-green-600 hover:bg-green-500 text-white py-2 rounded">
        สแกน QR เพื่อรับเข้า
      </button>
      <video id="recvVideo" playsinline class="w-full h-48 object-cover rounded mb-4 hidden"></video>

      <datalist id="inventoryList2"></datalist>
      <input list="inventoryList2" id="recvCodeInput"
             placeholder="พิมพ์รหัสหรือชื่อสินค้า"
             class="w-full border rounded p-2 mb-4" />

      <input id="recvQty" type="number" min="1" value="1"
             placeholder="จำนวนรับเข้า" class="w-full border rounded p-2 mb-4" />
      <button id="recvSubmit"
              class="w-full bg-green-600 hover:bg-green-500 text-white py-2 rounded">
        รับเข้า
      </button>
    </div>

    <!-- ประวัติ Table -->
    <div id="tabHistory" class="hidden">
      <div class="overflow-x-auto bg-white rounded shadow mb-2">
        <table class="min-w-full text-left">
          <thead class="bg-gray-200">
            <tr>
              <th class="px-4 py-2">วันที่/เวลา</th>
              <th class="px-4 py-2">รหัสสินค้า</th>
              <th class="px-4 py-2">จำนวน</th>
            </tr>
          </thead>
          <tbody id="historyTable" class="divide-y"></tbody>
        </table>
      </div>
      <div class="flex justify-between items-center">
        <button id="historyPrev"
                class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50"
                disabled>ก่อนหน้า</button>
        <span id="historyPageInfo" class="text-sm text-gray-600">หน้าที่ 1 จาก 1</span>
        <button id="historyNext"
                class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50"
                disabled>ถัดไป</button>
      </div>
    </div>
  </div>

  <script>
    // === Config ===
    const LIFF_ID = '2007335399-rmoYp9Md';
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbz-x6XGsMhuhkWOlBh8NAoVuiOopCXZdqJ_G3lyiUW5pq0TOGJToiqxHM2Rsit2xSVB/exec';

    const stockRef     = db.ref('stock');
    const receiveRef   = db.ref('receiveRecords');
    const issueRef     = db.ref('issueRecords');
    const employeesRef = db.ref('employees');

    let userIdLine = '', borrowerName = '';
    let historyRecords = [], historyPage = 1;
    const historyPageSize = 15;
    let basket = [];
    let currentMode = '';

    // UI Helpers
    function showCustomAlert(msg){
      const a = document.getElementById('customAlert');
      a.textContent = msg; a.classList.remove('hidden');
      setTimeout(()=>a.classList.add('hidden'),3000);
    }
    function activateTab(i,r,h){
      document.getElementById('tabIssue').classList.toggle('hidden',!i);
      document.getElementById('tabReceive').classList.toggle('hidden',!r);
      document.getElementById('tabHistory').classList.toggle('hidden',!h);
      document.getElementById('tabIssueBtn').classList.toggle('border-primary',i);
      document.getElementById('tabReceiveBtn').classList.toggle('border-primary',r);
      document.getElementById('tabHistoryBtn').classList.toggle('border-primary',h);
    }

    // LIFF Init
    window.onload = async () => {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) await liff.login();
      const profile = await liff.getProfile();
      userIdLine = profile.userId;

      const empSnap = await employeesRef.orderByChild('userIdLine')
                                        .equalTo(userIdLine).get();
      borrowerName = empSnap.exists()
        ? Object.values(empSnap.val())[0].fullName
        : 'ไม่ทราบชื่อ';
      document.getElementById('issueActorName').textContent   = borrowerName;
      document.getElementById('receiveActorName').textContent = borrowerName;

      // populate datalists
      async function fill(id){
        const dl = document.getElementById(id);
        const snap = await stockRef.once('value');
        snap.forEach(ch=>{
          const d = ch.val();
          const opt = document.createElement('option');
          opt.value = `${d.code} ‒ ${d.name}`;
          dl.appendChild(opt);
        });
      }
      await fill('inventoryList');
      await fill('inventoryList2');

      activateTab(true,false,false);
    };

    // QR Scan
    function startScan(mode){
      currentMode = mode;
      basket = [];
      const video = document.getElementById(mode==='issue'?'issVideo':'recvVideo');
      navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }}).then(stream=>{
        video.srcObject = stream;
        video.play();
        video.classList.remove('hidden');
        requestAnimationFrame(()=>tick(video));
      }).catch(()=>showCustomAlert('ไม่สามารถเข้าถึงกล้องได้'));
    }
    function tick(video){
      if(video.readyState===video.HAVE_ENOUGH_DATA){
        const c=document.createElement('canvas');
        c.width=video.videoWidth; c.height=video.videoHeight;
        const ctx=c.getContext('2d');
        ctx.drawImage(video,0,0);
        const code=jsQR(ctx.getImageData(0,0,c.width,c.height).data,c.width,c.height);
        if(code){
          handleScanResult(code.data.trim());
          video.srcObject.getTracks().forEach(t=>t.stop());
          video.classList.add('hidden');
          return;
        }
      }
      requestAnimationFrame(()=>tick(video));
    }

    async function handleScanResult(id){
      const snap = await stockRef.child(id).get();
      if(!snap.exists()) return showCustomAlert(`ไม่พบอุปกรณ์ ${id}`);
      const d = snap.val();
      if(currentMode==='issue'){
        if(!basket.find(x=>x.id===id)){
          basket.push({ id, name:d.name, qty:1 });
          updateIssueBasketUI();
        }
      } else {
        document.getElementById('recvCodeInput').value = `${id} ‒ ${d.name}`;
      }
    }

    function updateIssueBasketUI(){
      const ul = document.getElementById('issueItemsContainer');
      ul.innerHTML = basket.map(it=>`
        <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
          <span>${it.id} – ${it.name} × ${it.qty}</span>
        </div>`).join('');
    }

    // Manual addition of items
    async function addManualIssueItems(){
      const snap = await stockRef.once('value');
      const mapName = {};
      snap.forEach(ch=>{ const d=ch.val(); mapName[d.code]=d.name; });
      document.querySelectorAll('#issueItemsContainer .item-row').forEach(row=>{
        const raw = row.querySelector('.code-input').value.trim();
        const code = raw.split(' ‒ ')[0].trim();
        const qty  = parseInt(row.querySelector('.qty-input').value)||0;
        if(!code||qty<1) return;
        if(!basket.find(x=>x.id===code)){
          basket.push({ id:code, name:mapName[code]||'(ไม่พบชื่อ)', qty });
        }
      });
      updateIssueBasketUI();
    }
    document.getElementById('addIssueItem').onclick = addManualIssueItems;

    // bind buttons
    document.getElementById('tabIssueBtn').onclick   = ()=>activateTab(true,false,false);
    document.getElementById('tabReceiveBtn').onclick = ()=>activateTab(false,true,false);
    document.getElementById('tabHistoryBtn').onclick = ()=>activateTab(false,false,true);
    document.getElementById('issScanBtn').onclick     = ()=>startScan('issue');
    document.getElementById('recvScanBtn').onclick    = ()=>startScan('receive');

    // Notify via GAS
    async function getAdminIds(){
      const snap = await employeesRef.orderByChild('role').equalTo('admin').get();
      const ids = [];
      snap.forEach(ch=>{ const u=ch.val().userIdLine; if(u)ids.push(u); });
      return ids;
    }
    async function notifyAdmins(action, items){
      const admins = await getAdminIds();
      if(!admins.length) return;
      fetch(GAS_URL,{
        method:'POST', mode:'no-cors',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          action,
          user: borrowerName,
          userId: userIdLine,
          date: new Date().toISOString(),
          items,
          toList: admins
        })
      });
    }

    // เบิก (multi)
    document.getElementById('issSubmit').onclick = async ()=>{
      if(!basket.length) return showCustomAlert('ยังไม่มีรายการเบิก');
      const now = new Date().toISOString();
      for(const it of basket){
        const key = issueRef.push().key;
        await issueRef.child(key).set({
          id:key, date:now,
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          borrower: borrowerName,
          userId: userIdLine,
          itemCode: it.id,
          quantity: it.qty
        });
        await stockRef.child(it.id).child('quantity').transaction(c=>c-it.qty);
      }
      // LIFF message
      const summary = basket.map(it=>`${it.id}(${it.qty})`).join('\n');
      await liff.sendMessages([{ type:'text', text:`📤 เบิกหลายรายการ\n${summary}`}]);
      // Notify admins
      await notifyAdmins('issue-multi', basket);
      showCustomAlert('เบิกเรียบร้อย');
      basket=[]; updateIssueBasketUI();
    };

    // รับเข้า
    document.getElementById('recvSubmit').onclick = async ()=>{
      const raw = document.getElementById('recvCodeInput').value.trim();
      const [id,namePart] = raw.split(' ‒ ');
      const qty = +document.getElementById('recvQty').value;
      if(!id||qty<1) return showCustomAlert('กรุณาเลือกสินค้าและจำนวนให้ถูกต้อง');
      const now = new Date().toISOString();
      const key = receiveRef.push().key;
      await receiveRef.child(key).set({
        id:key, date:now,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        borrower: borrowerName,
        userId: userIdLine,
        itemCode: id,
        quantity: qty
      });
      await stockRef.child(id).child('quantity').transaction(c=>c+qty);
      // LIFF message
      await liff.sendMessages([{ type:'text', text:
        `📥 รับเข้าสินค้า\nรหัส: ${id}\nจำนวน: ${qty}\nผู้รับเข้า: ${borrowerName}` 
      }]);
      // Notify admins
      await notifyAdmins('receive', [{ code:id, name:namePart||'', qty }]);
      showCustomAlert('รับเข้าเรียบร้อย');
      document.getElementById('recvCodeInput').value = '';
    };

    // ประวัติ
    async function loadHistory(){
      const [rSnap,iSnap] = await Promise.all([
        receiveRef.once('value'),
        issueRef.once('value')
      ]);
      const recs=[];
      rSnap.forEach(ch=>{ const d=ch.val(); if(d.userId===userIdLine) recs.push({...d,type:'receive'});});
      iSnap.forEach(ch=>{ const d=ch.val(); if(d.userId===userIdLine) recs.push({...d,type:'issue'});});
      recs.sort((a,b)=>new Date(b.date)-new Date(a.date));
      historyRecords=recs; historyPage=1; renderHistory();
    }
    function renderHistory(){
      const start=(historyPage-1)*historyPageSize;
      const page=historyRecords.slice(start,start+historyPageSize);
      const tbody=document.getElementById('historyTable'); tbody.innerHTML='';
      page.forEach(d=>{
        const cls=d.type==='receive'?'bg-green-50':'bg-red-50';
        const tr=document.createElement('tr'); tr.className=cls;
        tr.innerHTML=`
          <td class="px-4 py-2">${new Date(d.date).toLocaleString('th-TH')}</td>
          <td class="px-4 py-2">${d.itemCode}</td>
          <td class="px-4 py-2">${d.quantity}</td>`;
        tbody.appendChild(tr);
      });
      const total = Math.max(1,Math.ceil(historyRecords.length/historyPageSize));
      document.getElementById('historyPageInfo').textContent=`หน้าที่ ${historyPage} จาก ${total}`;
      document.getElementById('historyPrev').disabled = historyPage===1;
      document.getElementById('historyNext').disabled = historyPage===total;
    }
    document.getElementById('historyPrev').onclick = ()=>{ if(historyPage>1){historyPage--;renderHistory();}};
    document.getElementById('historyNext').onclick = ()=>{ const t=Math.ceil(historyRecords.length/historyPageSize);
      if(historyPage<t){historyPage++;renderHistory();}};
  </script>
</body>
</html>
