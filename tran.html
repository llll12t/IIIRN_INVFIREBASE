<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>เบิกคลังสินค้า (LIFF Mode) พร้อมประวัติ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <!-- jsQR for QR scanning -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <!-- Your Firebase config -->
  <script src="firebase-config.js"></script>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

  <!-- Alert box -->
  <div id="customAlert"
       class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded shadow hidden z-50">
  </div>

  <div class="max-w-lg mx-auto p-6">
    <!-- Tabs -->
    <div class="flex mb-4 border-b">
      <button id="tabReceiveBtn"
              class="flex-1 py-2 text-center border-b-2 border-primary text-primary font-semibold">
        รับเข้า/เบิก
      </button>
      <button id="tabHistoryBtn"
              class="flex-1 py-2 text-center border-b-2 border-transparent hover:border-primary">
        ประวัติ
      </button>
    </div>

    <!-- Receive Tab -->
    <div id="tabReceive">
      <div class="bg-white p-4 rounded-lg mb-4">
        <h2 class="text-lg font-bold">ผู้เบิก : <span id="borrowerName">กำลังโหลด...</span></h2>
      </div>

      <!-- Search / Scan -->
      <datalist id="inventoryList"></datalist>
      <input list="inventoryList" id="searchInventoryInput"
             placeholder="พิมพ์รหัสหรือชื่อสินค้า"
             class="w-full border-gray-300 border rounded-lg p-2 mb-2" />
      <button id="scanBtn"
              class="w-full mb-4 bg-slate-800 hover:bg-slate-600 text-white py-3 rounded-lg">
        สแกน QR สินค้า
      </button>
      <video id="video" playsinline class="w-full h-48 object-cover rounded-lg mb-4 hidden"></video>

      <!-- Inventory info & quantity -->
      <div class="bg-white p-4 rounded-lg space-y-2 mb-4">
        <input id="invCode"   type="text" placeholder="รหัสสินค้า" readonly class="w-full border p-2 rounded" />
        <input id="invName"   type="text" placeholder="ชื่อสินค้า" readonly class="w-full border p-2 rounded" />
        <p id="remainStockInfo" class="text-sm text-gray-600">คงเหลือ: –</p>
        <p id="unitInfo"        class="text-sm text-gray-600">หน่วย: –</p>
        <input id="withdrawQty" type="number" min="1" value="1" placeholder="จำนวนที่เบิก" class="w-full border p-2 rounded" />
      </div>

      <!-- Withdraw button -->
      <button id="openConfirmBtn"
              class="w-full bg-green-600 hover:bg-green-500 text-white py-3 rounded-lg">
        เบิกสินค้า
      </button>
    </div>

    <!-- History Tab -->
    <div id="tabHistory" class="hidden">
      <div class="overflow-x-auto bg-white rounded-lg shadow mb-4">
        <table class="min-w-full text-left">
          <thead class="bg-secondary text-primary">
            <tr>
              <th class="px-4 py-2">วันที่</th>
              <th class="px-4 py-2">ชื่อ</th>
              <th class="px-4 py-2">จำนวน (ชิ้น)</th>
            </tr>
          </thead>
          <tbody id="historyTable" class="divide-y"></tbody>
        </table>
      </div>
      <!-- Pagination -->
      <div class="flex justify-between items-center">
        <button id="historyPrev"
                class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50"
                disabled>ก่อนหน้า</button>
        <span id="historyPageInfo" class="text-sm text-gray-600">หน้าที่ 1 จาก 1</span>
        <button id="historyNext"
                class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50"
                disabled>ถัดไป</button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal"
       class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-80 space-y-4">
      <h3 class="text-lg font-semibold">ยืนยันการเบิกสินค้า</h3>
      <p>ต้องการเบิกสินค้านี้ใช่หรือไม่?</p>
      <div class="flex justify-end gap-4">
        <button id="cancelBtn"
                class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">ยกเลิก</button>
        <button id="confirmBtn"
                class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg flex items-center gap-2">
          ยืนยัน
        </button>
      </div>
    </div>
  </div>

  <script>
    // --- LIFF + Firebase refs ---
    const LIFF_ID       = '2007335399-rmoYp9Md';
    const stockRef      = db.ref('stock');
    const issueRef      = db.ref('issueRecords');
    const employeesRef  = db.ref('employees');

    let userIdLine = '', borrowerName = '';

    // --- History state ---
    let historyRecords = [];
    const historyPageSize = 15;
    let historyPage = 1;

    // --- Tab elements ---
    const tabReceive = document.getElementById('tabReceive');
    const tabHistory = document.getElementById('tabHistory');
    document.getElementById('tabReceiveBtn').onclick = () => {
      tabReceive.classList.remove('hidden');
      tabHistory.classList.add('hidden');
      document.getElementById('tabReceiveBtn').classList.add('border-primary','font-semibold');
      document.getElementById('tabReceiveBtn').classList.remove('border-transparent');
      document.getElementById('tabHistoryBtn').classList.remove('border-primary','font-semibold');
      document.getElementById('tabHistoryBtn').classList.add('border-transparent');
    };
    document.getElementById('tabHistoryBtn').onclick = () => {
      tabReceive.classList.add('hidden');
      tabHistory.classList.remove('hidden');
      document.getElementById('tabHistoryBtn').classList.add('border-primary','font-semibold');
      document.getElementById('tabHistoryBtn').classList.remove('border-transparent');
      document.getElementById('tabReceiveBtn').classList.remove('border-primary','font-semibold');
      document.getElementById('tabReceiveBtn').classList.add('border-transparent');
      loadHistory();  // refresh when opening
    };

    // --- Alert helper ---
    function showCustomAlert(msg) {
      const a = document.getElementById('customAlert');
      a.textContent = msg;
      a.classList.remove('hidden');
      setTimeout(()=>a.classList.add('hidden'),3000);
    }

    // --- LIFF init & load user ---
    window.onload = async () => {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isInClient() && !liff.isLoggedIn()) {
        liff.login(); return;
      }
      const profile = await liff.getProfile();
      userIdLine = profile.userId;
      // Lookup employee
      const empSnap = await employeesRef.orderByChild('userIdLine').equalTo(userIdLine).get();
      borrowerName = empSnap.exists()
        ? Object.values(empSnap.val())[0].fullName
        : 'ไม่ทราบชื่อ';
      document.getElementById('borrowerName').textContent = borrowerName;

      // Populate inventoryList
      const dl = document.getElementById('inventoryList');
      stockRef.once('value').then(snap => {
        dl.innerHTML = '';
        snap.forEach(ch => {
          const d = ch.val();
          const opt = document.createElement('option');
          opt.value = `${d.code} ‒ ${d.name}`;
          dl.appendChild(opt);
        });
      });
    };

    // --- Set inventory info ---
    function setInventory(id) {
      stockRef.child(id).get().then(snap=>{
        if (!snap.exists()) return showCustomAlert('ไม่พบสินค้า');
        const d = snap.val();
        document.getElementById('invCode').value          = d.code;
        document.getElementById('invName').value          = d.name;
        document.getElementById('remainStockInfo').textContent = `คงเหลือ: ${d.quantity||0}`;
        document.getElementById('unitInfo').textContent       = `หน่วย: ${d.unit||'-'}`;
      });
    }
    document.getElementById('searchInventoryInput').addEventListener('input', e=>{
      const raw = e.target.value;
      const id  = raw.includes(' ‒ ') ? raw.split(' ‒ ')[0].trim() : raw.trim();
      if (id) setInventory(id);
    });

    // --- QR scan ---
    const canvas = document.createElement('canvas'), ctx = canvas.getContext('2d');
    document.getElementById('scanBtn').onclick = async ()=>{
      const video = document.getElementById('video');
      const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      video.srcObject=stream; video.play(); video.classList.remove('hidden');
      requestAnimationFrame(()=>scanLoop(video));
    };
    function scanLoop(video) {
      if(video.readyState===video.HAVE_ENOUGH_DATA){
        canvas.width=video.videoWidth; canvas.height=video.videoHeight;
        ctx.drawImage(video,0,0);
        const code=jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data,canvas.width,canvas.height);
        if(code){
          setInventory(code.data.trim());
          video.srcObject.getTracks().forEach(t=>t.stop());
          video.classList.add('hidden');
        }
      }
      if(video.srcObject) requestAnimationFrame(()=>scanLoop(video));
    }

    // --- Confirmation modal ---
    const confirmModal = document.getElementById('confirmModal');
    document.getElementById('openConfirmBtn').onclick = ()=>{
      const id  = document.getElementById('invCode').value;
      const qty = +document.getElementById('withdrawQty').value;
      if(!id) return showCustomAlert('กรุณาเลือกหรือสแกนสินค้า');
      if(qty<1) return showCustomAlert('กรุณากรอกจำนวนที่เบิก');
      confirmModal.classList.remove('hidden');
    };
    document.getElementById('cancelBtn').onclick = ()=>confirmModal.classList.add('hidden');

    // --- Submit issue ---
    document.getElementById('confirmBtn').onclick = async function(){
      const btn = this; btn.disabled=true;
      btn.innerHTML=`<svg class="animate-spin h-5 w-5 inline-block" viewBox="0 0 24 24">`
                  +`<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>`
                  +`<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg> กำลังบันทึก...`;
      await submitIssue();
      btn.innerHTML='✅ บันทึกสำเร็จ';
      setTimeout(()=>confirmModal.classList.add('hidden'),800);
    };
    async function submitIssue(){
      const recordId = issueRef.push().key;
      const now      = new Date().toISOString();
      const code     = document.getElementById('invCode').value;
      const name     = document.getElementById('invName').value;
      const qty      = +document.getElementById('withdrawQty').value;
      await issueRef.child(recordId).set({
        id:        recordId,
        date:      now,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        borrower:  borrowerName,
        userId:    userIdLine,
        itemCode:  code,
        itemName:  name,
        quantity:  qty
      });
      await stockRef.child(code).child('quantity').transaction(c=>(c||0)-qty);
    }

    // --- Load & render history ---
    async function loadHistory(){
      const [rSnap,iSnap] = await Promise.all([ issueRef.once('value'), issueRef.once('value') ]);
      // note: use issueRef for both or combine receiveRef if needed
      const recs = [];
      iSnap.forEach(ch=>{
        const d=ch.val();
        recs.push(d);
      });
      recs.sort((a,b)=>new Date(b.date)-new Date(a.date));
      historyRecords=recs;
      historyPage=1;
      renderHistory();
    }
    function renderHistory(){
      const start=(historyPage-1)*historyPageSize;
      const page=recs=historyRecords.slice(start,start+historyPageSize);
      const tbody=document.getElementById('historyTable');
      tbody.innerHTML='';
      page.forEach(d=>{
        const cls = 'bg-red-50';  // all issue here; adjust if both types
        const tr=document.createElement('tr');
        tr.className=cls;
        tr.innerHTML=`
          <td class="px-4 py-2">${new Date(d.date).toLocaleDateString('th-TH')}</td>
          <td class="px-4 py-2">${d.itemName}</td>
          <td class="px-4 py-2">${d.quantity}</td>`;
        tbody.appendChild(tr);
      });
      const totalPages = Math.ceil(historyRecords.length/historyPageSize)||1;
      document.getElementById('historyPageInfo').textContent=
        `หน้าที่ ${historyPage} จาก ${totalPages}`;
      document.getElementById('historyPrev').disabled = historyPage===1;
      document.getElementById('historyNext').disabled = historyPage===totalPages;
    }
    document.getElementById('historyPrev').onclick=()=>{
      if(historyPage>1){historyPage--;renderHistory();}
    };
    document.getElementById('historyNext').onclick=()=>{
      const tp=Math.ceil(historyRecords.length/historyPageSize);
      if(historyPage<tp){historyPage++;renderHistory();}
    };
  </script>
</body>
</html>
