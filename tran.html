<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏ö‡∏¥‡∏Å/‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ + ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <!-- jsQR for QR scanning -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
    <script src="firebase-config.js"></script>

  <style>
    #customAlert { transition: opacity .3s; opacity: 0; }
    #customAlert.show { opacity: 1; }
  </style>
  
</head>
<body class="bg-gray-100 min-h-screen font-sans">

  <!-- Alert -->
  <div id="customAlert"
       class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded shadow z-50">
  </div>

  <div class="max-w-lg mx-auto p-6 space-y-6 bg-white rounded-lg mt-10">
    <!-- Tabs -->
    <div class="flex mb-4 border-b">
      <button id="tabIssueBtn"   class="flex-1 py-2 text-center border-b-2 border-primary font-semibold">‡πÄ‡∏ö‡∏¥‡∏Å</button>
      <button id="tabReceiveBtn" class="flex-1 py-2 text-center border-b-2 border-transparent hover:border-primary">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</button>
      <button id="tabHistoryBtn" class="flex-1 py-2 text-center border-b-2 border-transparent hover:border-primary">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
    </div>

    <!-- ‡πÄ‡∏ö‡∏¥‡∏Å (‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) -->
    <div id="tabIssue">
      <div class="text-center mb-4">
        <h2 class="text-lg font-bold">‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
        <p>‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å: <span id="actorIssue" class="font-semibold">‚Äì</span></p>
      </div>
      <button id="scanIssueBtn" class="w-full mb-4 bg-red-600 hover:bg-red-500 text-white py-2 rounded">
        ‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      </button>
      <video id="videoIssue" playsinline class="w-full h-48 object-cover rounded hidden mb-4"></video>
      <datalist id="inventoryList"></datalist>
      <ul id="basketIssue" class="space-y-2 mb-4"></ul>
      <div class="flex space-x-2 mb-4">
        <input list="inventoryList" id="manualCodeIssue" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" class="flex-1 border rounded p-2" />
        <input type="number" id="manualQtyIssue" min="1" value="1" class="w-20 border rounded p-2" />
        <button id="addIssueBtn" class="bg-blue-600 text-white px-4 py-2 rounded">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      </div>
      <button id="submitIssueBtn" class="w-full bg-red-600 hover:bg-red-500 text-white py-2 rounded disabled:opacity-50" disabled>
        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å (‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
      </button>
    </div>

    <!-- ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ (‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) -->
    <div id="tabReceive" class="hidden">
      <div class="text-center mb-4">
        <h2 class="text-lg font-bold">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
        <p>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤: <span id="actorReceive" class="font-semibold">‚Äì</span></p>
      </div>
      <button id="scanReceiveBtn" class="w-full mb-4 bg-green-600 hover:bg-green-500 text-white py-2 rounded">
        ‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      </button>
      <video id="videoReceive" playsinline class="w-full h-48 object-cover rounded hidden mb-4"></video>
      <datalist id="inventoryList2"></datalist>
      <ul id="basketReceive" class="space-y-2 mb-4"></ul>
      <div class="flex space-x-2 mb-4">
        <input list="inventoryList2" id="manualCodeReceive" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" class="flex-1 border rounded p-2" />
        <input type="number" id="manualQtyReceive" min="1" value="1" class="w-20 border rounded p-2" />
        <button id="addReceiveBtn" class="bg-blue-600 text-white px-4 py-2 rounded">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      </div>
      <button id="submitReceiveBtn" class="w-full bg-green-600 hover:bg-green-500 text-white py-2 rounded disabled:opacity-50" disabled>
        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ (‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
      </button>
    </div>

    <!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ -->
    <div id="tabHistory" class="hidden">
      <div class="overflow-x-auto bg-white rounded shadow mb-2">
        <table class="min-w-full text-left">
          <thead class="bg-gray-200">
            <tr>
              <th class="px-4 py-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th class="px-4 py-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
              <th class="px-4 py-2">‡∏£‡∏´‡∏±‡∏™-‡∏ä‡∏∑‡πà‡∏≠</th>
              <th class="px-4 py-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
            </tr>
          </thead>
          <tbody id="historyTable" class="divide-y"></tbody>
        </table>
      </div>
      <div class="flex justify-between items-center">
        <button id="historyPrev" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50" disabled>‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
        <span id="historyPageInfo" class="text-sm text-gray-600">‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà 1 ‡∏à‡∏≤‡∏Å 1</span>
        <button id="historyNext" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
      </div>
    </div>
  </div>

  <script>
    const LIFF_ID       = '2007335399-rmoYp9Md';
    const GAS_URL       = 'https://script.google.com/macros/s/AKfycbz-x6XGsMhuhkWOlBh8NAoVuiOopCXZdqJ_G3lyiUW5pq0TOGJToiqxHM2Rsit2xSVB/exec';
    const stockRef      = db.ref('stock');
    const issueRef      = db.ref('issueRecords');
    const receiveRef    = db.ref('receiveRecords');
    const employeesRef  = db.ref('employees');

    let userIdLine      = '';
    let actorIssue      = '';
    let actorReceive    = '';
    let basketIssue     = [];
    let basketReceive   = [];
    let historyRecords  = [];
    let historyPage     = 1;
    const pageSize      = 15;

    function showAlert(msg){
      const a = document.getElementById('customAlert');
      a.textContent = msg;
      a.classList.add('show');
      setTimeout(()=>a.classList.remove('show'),2000);
    }

    function updateBasket(listId, basket, btnId){
      document.getElementById(listId).innerHTML = basket.map(it=>`
        <li class="flex justify-between items-center bg-gray-50 p-2 rounded">
          <span>${it.code} ‚Äì ${it.name} √ó ${it.qty}</span>
          <button onclick="removeFromBasket('${listId}','${it.code}','${btnId}')" class="text-red-500 font-bold">√ó</button>
        </li>`).join('');
      document.getElementById(btnId).disabled = basket.length===0;
    }
    window.removeFromBasket = (listId,code,btnId) => {
      if(listId==='basketIssue') basketIssue = basketIssue.filter(x=>x.code!==code), updateBasket('basketIssue',basketIssue,'submitIssueBtn');
      else                     basketReceive = basketReceive.filter(x=>x.code!==code), updateBasket('basketReceive',basketReceive,'submitReceiveBtn');
    };

    async function liffInit(){
      await liff.init({ liffId: LIFF_ID });
      if(!liff.isLoggedIn()) await liff.login();
      const prof = await liff.getProfile();
      userIdLine = prof.userId;
      const snapIssue = await employeesRef.orderByChild('userIdLine').equalTo(userIdLine).get();
      actorIssue   = snapIssue.exists()? Object.values(snapIssue.val())[0].fullName : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠';
      actorReceive = actorIssue;
      document.getElementById('actorIssue').textContent   = actorIssue;
      document.getElementById('actorReceive').textContent = actorReceive;
      const snapStock = await stockRef.once('value');
      snapStock.forEach(ch=>{
        const d = ch.val();
        ['inventoryList','inventoryList2'].forEach(id=>{
          document.getElementById(id).insertAdjacentHTML('beforeend',`<option value="${d.code} ‚Äí ${d.name}">`);
        });
      });
    }

    function setupScan(btnId,videoId,listKey){
      document.getElementById(btnId).onclick = async ()=>{
        const video = document.getElementById(videoId);
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:'environment'} });
          video.srcObject = stream; video.play(); video.classList.remove('hidden');
          const canvas=document.createElement('canvas'),ctx=canvas.getContext('2d');
          (function scan(){
            if(video.readyState===video.HAVE_ENOUGH_DATA){
              canvas.width=video.videoWidth; canvas.height=video.videoHeight;
              ctx.drawImage(video,0,0);
              const code=jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data,canvas.width,canvas.height);
              if(code){
                addToBasket(listKey,code.data.trim());
                stream.getTracks().forEach(t=>t.stop());
                video.classList.add('hidden');
                return;
              }
            }
            requestAnimationFrame(scan);
          })();
        } catch {
          showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ');
        }
      };
    }
    setupScan('scanIssueBtn','videoIssue','issue');
    setupScan('scanReceiveBtn','videoReceive','receive');

    async function addToBasket(key, code){
      const snap = await stockRef.child(code).get();
      if(!snap.exists()) return showAlert(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${code}`);
      const d = snap.val();
      const target = key==='issue'? basketIssue : basketReceive;
      if(!target.find(x=>x.code===code)){
        target.push({ code, name:d.name, qty:1 });
        updateBasket(key==='issue'? 'basketIssue':'basketReceive', target, key==='issue'? 'submitIssueBtn':'submitReceiveBtn');
      }
    }

    document.getElementById('addIssueBtn').onclick = ()=> {
      const raw = document.getElementById('manualCodeIssue').value.trim();
      const code=raw.split(' ‚Äí ')[0], qty=+document.getElementById('manualQtyIssue').value;
      if(!code||qty<1) return showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      addToBasket('issue',code);
      basketIssue.find(x=>x.code===code).qty = qty;
      updateBasket('basketIssue',basketIssue,'submitIssueBtn');
    };
    document.getElementById('addReceiveBtn').onclick = ()=> {
      const raw = document.getElementById('manualCodeReceive').value.trim();
      const code=raw.split(' ‚Äí ')[0], qty=+document.getElementById('manualQtyReceive').value;
      if(!code||qty<1) return showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      addToBasket('receive',code);
      basketReceive.find(x=>x.code===code).qty = qty;
      updateBasket('basketReceive',basketReceive,'submitReceiveBtn');
    };

    async function getAdminIds(){
      const snap=await employeesRef.orderByChild('role').equalTo('admin').get();
      const ids=[]; snap.forEach(ch=>{ const u=ch.val().userIdLine; if(u)ids.push(u); });
      return ids;
    }
    async function notifyAdmins(action,items){
      const toList = await getAdminIds();
      if(!toList.length) return;
      fetch(GAS_URL,{
        method:'POST', mode:'no-cors',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action, user:(action==='issue'?actorIssue:actorReceive), userId:userIdLine, date:new Date().toISOString(), items, toList })
      });
    }

    document.getElementById('submitIssueBtn').onclick = async ()=>{
      if(!basketIssue.length) return;
      const now=new Date().toISOString(), items=[];
      for(const it of basketIssue){
        const key=issueRef.push().key;
        await issueRef.child(key).set({ id:key,date:now,timestamp:firebase.database.ServerValue.TIMESTAMP, borrower:actorIssue,userId:userIdLine,itemCode:it.code,itemName:it.name,quantity:it.qty });
        await stockRef.child(it.code).child('quantity').transaction(c=>c-it.qty);
        items.push(it);
      }
      const contents=[
        {type:"text",text:"üì§ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",weight:"bold",size:"lg",color:"#C0392B"},
        {type:"text",text:`‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å: ${actorIssue}`,size:"sm",margin:"md"},
        {type:"separator",margin:"md"},
        ...items.map(it=>({
          type:"box",layout:"baseline",spacing:"sm",margin:"md",
          contents:[
            {type:"text",text:it.code,flex:1,size:"sm",color:"#555"},
            {type:"text",text:`${it.name} √ó ${it.qty}`,flex:3,size:"sm",wrap:true}
          ]
        }))
      ];
      await liff.sendMessages([{type:'flex',altText:'üì§ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',contents:{type:"bubble",body:{type:"box",layout:"vertical",contents}}}]);
      await notifyAdmins('issue',items);
      showAlert('‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      basketIssue=[]; updateBasket('basketIssue',[], 'submitIssueBtn');
    };

    document.getElementById('submitReceiveBtn').onclick = async ()=>{
      if(!basketReceive.length) return;
      const now=new Date().toISOString(), items=[];
      for(const it of basketReceive){
        const key=receiveRef.push().key;
        await receiveRef.child(key).set({ id:key,date:now,timestamp:firebase.database.ServerValue.TIMESTAMP, borrower:actorReceive,userId:userIdLine,itemCode:it.code,itemName:it.name,quantity:it.qty });
        await stockRef.child(it.code).child('quantity').transaction(c=>c+it.qty);
        items.push(it);
      }
      const contents=[
        {type:"text",text:"üì• ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",weight:"bold",size:"lg",color:"#27AE60"},
        {type:"text",text:`‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤: ${actorReceive}`,size:"sm",margin:"md"},
        {type:"separator",margin:"md"},
        ...items.map(it=>({
          type:"box",layout:"baseline",spacing:"sm",margin:"md",
          contents:[
            {type:"text",text:it.code,flex:1,size:"sm",color:"#555"},
            {type:"text",text:`${it.name} √ó ${it.qty}`,flex:3,size:"sm",wrap:true}
          ]
        }))
      ];
      await liff.sendMessages([{type:'flex',altText:'üì• ‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',contents:{type:"bubble",body:{type:"box",layout:"vertical",contents}}}]);
      await notifyAdmins('receive',items);
      showAlert('‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      basketReceive=[]; updateBasket('basketReceive',[], 'submitReceiveBtn');
    };

    async function loadHistory(){
      const [rSnap,iSnap]=await Promise.all([receiveRef.once('value'),issueRef.once('value')]);
      const recs=[];
      rSnap.forEach(ch=>{const d=ch.val(); if(d.userId===userIdLine) recs.push({...d,type:'receive'});});
      iSnap.forEach(ch=>{const d=ch.val(); if(d.userId===userIdLine) recs.push({...d,type:'issue'});});
      recs.sort((a,b)=>new Date(b.date)-new Date(a.date));
      historyRecords=recs; historyPage=1; renderHistory();
    }
    function renderHistory(){
      const start=(historyPage-1)*pageSize;
      const page=historyRecords.slice(start,start+pageSize);
      const tbody=document.getElementById('historyTable');
      tbody.innerHTML='';
      page.forEach(d=>{
        const cls=d.type==='receive'?'bg-green-50':'bg-red-50';
        const tr=document.createElement('tr'); tr.className=cls;
        tr.innerHTML=`
          <td class="px-4 py-2">${new Date(d.date).toLocaleString('th-TH')}</td>
          <td class="px-4 py-2">${d.type==='receive'?'‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤':'‡πÄ‡∏ö‡∏¥‡∏Å'}</td>
          <td class="px-4 py-2">${d.itemCode} ‚Äí ${d.itemName}</td>
          <td class="px-4 py-2">${d.quantity}</td>`;
        tbody.appendChild(tr);
      });
      const total=Math.max(1,Math.ceil(historyRecords.length/pageSize));
      document.getElementById('historyPageInfo').textContent=`‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ${historyPage} ‡∏à‡∏≤‡∏Å ${total}`;
      document.getElementById('historyPrev').disabled = historyPage===1;
      document.getElementById('historyNext').disabled = historyPage===total;
    }
    document.getElementById('historyPrev').onclick=()=>{if(historyPage>1){historyPage--;renderHistory();}};
    document.getElementById('historyNext').onclick=()=>{const t=Math.ceil(historyRecords.length/pageSize);if(historyPage<t){historyPage++;renderHistory();}};
    
    // Tab switching
    document.getElementById('tabIssueBtn').onclick   = ()=>activateTab(true,false,false);
    document.getElementById('tabReceiveBtn').onclick = ()=>activateTab(false,true,false);
    document.getElementById('tabHistoryBtn').onclick = ()=>{ activateTab(false,false,true); loadHistory(); };
    function activateTab(i,r,h){
      document.getElementById('tabIssue').classList.toggle('hidden',!i);
      document.getElementById('tabReceive').classList.toggle('hidden',!r);
      document.getElementById('tabHistory').classList.toggle('hidden',!h);
      document.getElementById('tabIssueBtn').classList.toggle('border-primary',i);
      document.getElementById('tabReceiveBtn').classList.toggle('border-primary',r);
      document.getElementById('tabHistoryBtn').classList.toggle('border-primary',h);
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    liffInit();
  </script>
</body>
</html>
