<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (LIFF Mode)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <!-- jsQR for QR scanning -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <!-- Your Firebase config -->
  <script src="firebase-config.js"></script>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

  <!-- Alert -->
  <div id="customAlert"
       class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded shadow hidden z-50">
  </div>

  <div class="max-w-lg mx-auto p-6 space-y-6">
    <!-- Tabs -->
    <div class="flex mb-4 border-b">
      <button id="tabIssueBtn"
              class="flex-1 py-2 text-center border-b-2 border-primary font-semibold">
        ‡πÄ‡∏ö‡∏¥‡∏Å
      </button>
      <button id="tabReceiveBtn"
              class="flex-1 py-2 text-center border-b-2 border-transparent hover:border-primary">
        ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤
      </button>
      <button id="tabHistoryBtn"
              class="flex-1 py-2 text-center border-b-2 border-transparent hover:border-primary">
        ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
      </button>
    </div>

    <!-- ‡πÄ‡∏ö‡∏¥‡∏Å Form -->
    <div id="tabIssue">
      <div class="bg-white p-4 rounded-lg mb-4">
        <div class="mb-2"><span class="font-bold">‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å:</span> <span id="issueActorName">‚Äì</span></div>
        <div class="grid grid-cols-3 gap-4">
          <div>
            <span class="font-semibold">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
            <div id="issCodeDisplay" class="mt-1 text-lg">‚Äì</div>
          </div>
          <div>
            <span class="font-semibold">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
            <div id="issNameDisplay" class="mt-1 text-lg">‚Äì</div>
          </div>
          <div>
            <span class="font-semibold">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>
            <div id="issRemainDisplay" class="mt-1 text-lg">‚Äì</div>
          </div>
        </div>
      </div>

      <datalist id="inventoryList"></datalist>
      <input list="inventoryList" id="issCodeInput"
             placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
             class="w-full border rounded p-2 mb-2" />

      <button id="issScanBtn"
              class="w-full mb-4 bg-red-600 hover:bg-red-500 text-white py-2 rounded">
        ‡∏™‡πÅ‡∏Å‡∏ô QR
      </button>
      <video id="issVideo" playsinline class="w-full h-48 object-cover rounded mb-4 hidden"></video>

      <input id="issQty" type="number" min="1" value="1"
             placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å" class="w-full border rounded p-2 mb-4" />

      <button id="issSubmit"
              class="w-full bg-red-600 hover:bg-red-500 text-white py-2 rounded">
        ‡πÄ‡∏ö‡∏¥‡∏Å
      </button>
    </div>

    <!-- ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ Form -->
    <div id="tabReceive" class="hidden">
      <div class="bg-white p-4 rounded-lg mb-4">
        <div class="mb-2"><span class="font-bold">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤:</span> <span id="receiveActorName">‚Äì</span></div>
        <div class="grid grid-cols-3 gap-4">
          <div>
            <span class="font-semibold">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
            <div id="recvCodeDisplay" class="mt-1 text-lg">‚Äì</div>
          </div>
          <div>
            <span class="font-semibold">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
            <div id="recvNameDisplay" class="mt-1 text-lg">‚Äì</div>
          </div>
          <div>
            <span class="font-semibold">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>
            <div id="recvRemainDisplay" class="mt-1 text-lg">‚Äì</div>
          </div>
        </div>
      </div>

      <datalist id="inventoryList2"></datalist>
      <input list="inventoryList2" id="recvCodeInput"
             placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
             class="w-full border rounded p-2 mb-2" />

      <button id="recvScanBtn"
              class="w-full mb-4 bg-green-600 hover:bg-green-500 text-white py-2 rounded">
        ‡∏™‡πÅ‡∏Å‡∏ô QR
      </button>
      <video id="recvVideo" playsinline class="w-full h-48 object-cover rounded mb-4 hidden"></video>

      <input id="recvQty" type="number" min="1" value="1"
             placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤" class="w-full border rounded p-2 mb-4" />

      <button id="recvSubmit"
              class="w-full bg-green-600 hover:bg-green-500 text-white py-2 rounded">
        ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤
      </button>
    </div>

    <!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Table -->
    <div id="tabHistory" class="hidden">
      <div class="overflow-x-auto bg-white rounded shadow mb-2">
        <table class="min-w-full text-left">
          <thead class="bg-gray-200">
            <tr>
              <th class="px-4 py-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th class="px-4 py-2">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
              <th class="px-4 py-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ä‡∏¥‡πâ‡∏ô)</th>
            </tr>
          </thead>
          <tbody id="historyTable" class="divide-y"></tbody>
        </table>
      </div>
      <div class="flex justify-between items-center">
        <button id="historyPrev"
                class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50"
                disabled>‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
        <span id="historyPageInfo" class="text-sm text-gray-600">‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà 1 ‡∏à‡∏≤‡∏Å 1</span>
        <button id="historyNext"
                class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50"
                disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const LIFF_ID  = '2007335399-rmoYp9Md';
    const GAS_URL  = 'https://script.google.com/macros/s/AKfycbz-x6XGsMhuhkWOlBh8NAoVuiOopCXZdqJ_G3lyiUW5pq0TOGJToiqxHM2Rsit2xSVB/exec';  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

    // Firebase refs
    const stockRef     = db.ref('stock');
    const receiveRef   = db.ref('receiveRecords');
    const issueRef     = db.ref('issueRecords');
    const employeesRef = db.ref('employees');

    let userIdLine = '', borrowerName = '';

    // ‡∏î‡∏∂‡∏á userIdLine ‡∏Ç‡∏≠‡∏á admin ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    async function getAdminIds() {
      const snap = await employeesRef.orderByChild('role').equalTo('admin').get();
      const ids = [];
      snap.forEach(ch => {
        const u = ch.val().userIdLine;
        if (u) ids.push(u);
      });
      return ids;
    }

    // ‡∏™‡πà‡∏á POST ‡πÑ‡∏õ‡∏¢‡∏±‡∏á GAS ‡∏û‡∏£‡πâ‡∏≠‡∏° action, code, name, qty, user ‡πÅ‡∏•‡∏∞ toList
    async function notifyAdmins(action, code, name, qty, user) {
      const adminIds = await getAdminIds();
      if (adminIds.length === 0) return;
      await fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, code, name, qty, user, toList: adminIds })
      });
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏™‡∏î‡∏á alert
    function showCustomAlert(msg) {
      const a = document.getElementById('customAlert');
      a.textContent = msg;
      a.classList.remove('hidden');
      setTimeout(() => a.classList.add('hidden'), 3000);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô init LIFF + ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user
    window.onload = async () => {
      await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
      if (!liff.isInClient() && !liff.isLoggedIn()) {
        await liff.login({ scope: 'profile openid chat_message.write' });
        return;
      }
      const profile = await liff.getProfile();
      userIdLine = profile.userId;
      // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å employees
      const empSnap = await employeesRef.orderByChild('userIdLine').equalTo(userIdLine).get();
      borrowerName = empSnap.exists()
        ? Object.values(empSnap.val())[0].fullName
        : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠';

      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° datalist ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      stockRef.once('value').then(snap => {
        snap.forEach(ch => {
          const d = ch.val();
          const opt1 = document.createElement('option');
          opt1.value = `${d.code} ‚Äí ${d.name}`;
          document.getElementById('inventoryList').appendChild(opt1);
        });
      });
    };

    // ‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‚Üí ‡∏™‡πà‡∏á LIFF ‚Üí notifyAdmins ‚Üí ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå form
    document.getElementById('issSubmit').onclick = async () => {
      // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ code, qty, name
      const raw  = document.getElementById('issCodeInput').value;
      const code = raw.split(' ‚Äí ')[0].trim();
      const qty  = +document.getElementById('issQty').value;
      if (!code)      return showCustomAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
      if (qty < 1)     return showCustomAlert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      // ‡∏ï‡∏£‡∏ß‡∏à stock
      const snap     = await stockRef.child(code).get();
      const avail    = snap.val().quantity || 0;
      if (avail < qty) return showCustomAlert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å');
      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      const name     = snap.val().name;
      const recordId = issueRef.push().key;
      const now      = new Date().toISOString();
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase
      await issueRef.child(recordId).set({
        id: recordId,
        date: now,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        borrower: borrowerName,
        userId: userIdLine,
        itemCode: code,
        itemName: name,
        quantity: qty
      });
      await stockRef.child(code).child('quantity').transaction(c => (c||0) - qty);
      // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
      await liff.sendMessages([{
        type: 'text',
        text: `üì§ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤\n‡∏£‡∏´‡∏±‡∏™: ${code}\n‡∏ä‡∏∑‡πà‡∏≠: ${name}\n‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${qty}\n‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å: ${borrowerName}`
      }]);
      // ‡∏™‡πà‡∏á POST ‡πÅ‡∏à‡πâ‡∏á admin
      await notifyAdmins('issue', code, name, qty, borrowerName);
      // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°
      document.getElementById('issCodeInput').value = '';
      document.getElementById('issQty').value      = '1';
      showCustomAlert('‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    };

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏à‡∏∞‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ref ‡πÄ‡∏õ‡πá‡∏ô receiveRef ‡πÅ‡∏•‡∏∞ prefix ‡πÄ‡∏õ‡πá‡∏ô "üì• ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
    document.getElementById('recvSubmit').onclick = async () => {
      const raw  = document.getElementById('recvCodeInput').value;
      const code = raw.split(' ‚Äí ')[0].trim();
      const qty  = +document.getElementById('recvQty').value;
      if (!code)  return showCustomAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
      if (qty<1)  return showCustomAlert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      const snap     = await stockRef.child(code).get();
      const name     = snap.val().name;
      const recordId = receiveRef.push().key;
      const now      = new Date().toISOString();
      await receiveRef.child(recordId).set({
        id: recordId,
        date: now,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        borrower: borrowerName,
        userId: userIdLine,
        itemCode: code,
        itemName: name,
        quantity: qty
      });
      await stockRef.child(code).child('quantity').transaction(c => (c||0) + qty);
      await liff.sendMessages([{
        type: 'text',
        text: `üì• ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤\n‡∏£‡∏´‡∏±‡∏™: ${code}\n‡∏ä‡∏∑‡πà‡∏≠: ${name}\n‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${qty}\n‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤: ${borrowerName}`
      }]);
      await notifyAdmins('receive', code, name, qty, borrowerName);
      document.getElementById('recvCodeInput').value = '';
      document.getElementById('recvQty').value      = '1';
      showCustomAlert('‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    };
  </script>
</body>
</html>
