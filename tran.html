<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏ö‡∏¥‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <!-- jsQR for QR scanning -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <!-- Firebase Config -->
  <script src="firebase-config.js"></script>

</head>
<body class="bg-gray-100 min-h-screen font-sans">

  <!-- Alert -->
  <div id="customAlert"
       class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded shadow hidden z-50">
  </div>

  <div class="max-w-lg mx-auto p-6 space-y-6">
    <!-- Header -->
    <div class="bg-white p-4 rounded-lg">
      <div><span class="font-bold">‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å:</span> <span id="actorName">‚Äì</span></div>
    </div>

    <!-- ‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -->
    <button id="scanBtn"
            class="w-full mb-4 bg-red-600 hover:bg-red-500 text-white py-2 rounded">
      ‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    </button>
    <video id="video" playsinline class="w-full h-48 object-cover rounded mb-4 hidden"></video>

    <!-- datalist ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö autocomplete -->
    <datalist id="inventoryList"></datalist>

    <!-- ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÄ‡∏ö‡∏¥‡∏Å -->
    <ul id="basket" class="space-y-2 mb-4"></ul>

    <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÇ‡∏Ñ‡πâ‡∏î + ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô + ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠ -->
    <div class="flex space-x-2 mb-4">
      <input list="inventoryList" id="manualCode"
             placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
             class="flex-1 border rounded p-2" />
      <input type="number" id="manualQty" min="1" value="1"
             class="w-20 border rounded p-2" />
      <button id="addBtn" class="bg-blue-600 text-white px-4 py-2 rounded">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -->
    <button id="submitBtn"
            class="w-full bg-red-600 hover:bg-red-500 text-white py-2 rounded disabled:opacity-50"
            disabled>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å (‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</button>
  </div>

  <script>
    const LIFF_ID      = '2007335399-rmoYp9Md';
    const GAS_URL      = 'https://script.google.com/macros/s/XXXXXXXX/exec';
    const db           = firebase.database();
    const stockRef     = db.ref('stock');
    const issueRef     = db.ref('issueRecords');
    const employeesRef = db.ref('employees');

    let userIdLine = '', actorName = '';
    let basket = [];

    // UI Helpers
    function alertMsg(msg){
      const a = document.getElementById('customAlert');
      a.textContent = msg; a.classList.remove('hidden');
      setTimeout(()=>a.classList.add('hidden'),2000);
    }
    function updateBasketUI(){
      const ul = document.getElementById('basket');
      ul.innerHTML = basket.map(it=>`
        <li class="flex justify-between items-center bg-white p-2 rounded shadow">
          <span>${it.code} ‚Äì ${it.name} √ó ${it.qty}</span>
          <button onclick="removeItem('${it.code}')" class="text-red-500 font-bold">‡∏•‡∏ö</button>
        </li>
      `).join('');
      document.getElementById('submitBtn').disabled = !basket.length;
    }
    function removeItem(code){
      basket = basket.filter(x=>x.code!==code);
      updateBasketUI();
    }

    // LIFF Init
    window.onload = async ()=>{
      await liff.init({liffId:LIFF_ID});
      if(!liff.isLoggedIn()) await liff.login();
      const p = await liff.getProfile();
      userIdLine = p.userId;
      // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
      const snap = await employeesRef.orderByChild('userIdLine').equalTo(userIdLine).get();
      actorName = snap.exists()? Object.values(snap.val())[0].fullName : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠';
      document.getElementById('actorName').textContent = actorName;
      // ‡πÄ‡∏ï‡∏¥‡∏° datalist
      const dl = document.getElementById('inventoryList');
      const s = await stockRef.once('value');
      s.forEach(ch=>{
        const d = ch.val();
        dl.insertAdjacentHTML('beforeend', `<option value="${d.code} ‚Äí ${d.name}">`);
      });
    };

    // ‡∏™‡πÅ‡∏Å‡∏ô QR
    document.getElementById('scanBtn').onclick = async ()=>{
      const video = document.getElementById('video');
      try {
        const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
        video.srcObject = stream; video.play(); video.classList.remove('hidden');
        const canvas = document.createElement('canvas'), ctx = canvas.getContext('2d');
        (function tick(){
          if(video.readyState===video.HAVE_ENOUGH_DATA){
            canvas.width=video.videoWidth; canvas.height=video.videoHeight;
            ctx.drawImage(video,0,0);
            const code = jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data,canvas.width,canvas.height);
            if(code){
              handleScan(code.data.trim());
              stream.getTracks().forEach(t=>t.stop());
              video.classList.add('hidden');
              return;
            }
          }
          requestAnimationFrame(tick);
        })();
      } catch(e){
        alertMsg('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ');
      }
    };

    async function handleScan(code){
      const snap = await stockRef.child(code).get();
      if(!snap.exists()) return alertMsg(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${code}`);
      const d = snap.val();
      // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô basket ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°
      if(!basket.find(x=>x.code===code)){
        basket.push({ code, name:d.name, qty:1 });
        updateBasketUI();
      }
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠
    document.getElementById('addBtn').onclick = async ()=>{
      const raw = document.getElementById('manualCode').value.trim();
      if(!raw) return;
      const code = raw.split(' ‚Äí ')[0];
      const qty  = +document.getElementById('manualQty').value;
      if(qty<1) return alertMsg('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      const snap = await stockRef.child(code).get();
      if(!snap.exists()) return alertMsg(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${code}`);
      const d = snap.val();
      if(!basket.find(x=>x.code===code)){
        basket.push({ code, name:d.name, qty });
        updateBasketUI();
      }
    };

    // Notify Admin via GAS
    async function getAdminIds(){
      const snap = await employeesRef.orderByChild('role').equalTo('admin').get();
      const ids = [];
      snap.forEach(ch=>{
        const u=ch.val().userIdLine;
        if(u) ids.push(u);
      });
      return ids;
    }
    async function notifyAdmins(action, items){
      const admins = await getAdminIds();
      if(!admins.length) return;
      fetch(GAS_URL,{
        method:'POST', mode:'no-cors',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          action, user:actorName, userId:userIdLine,
          date:new Date().toISOString(), items, toList:admins
        })
      });
    }

    // ‡∏™‡πà‡∏á‡πÄ‡∏ö‡∏¥‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    document.getElementById('submitBtn').onclick = async ()=>{
      if(!basket.length) return;
      const now = new Date().toISOString();
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      for(const it of basket){
        const key = issueRef.push().key;
        await issueRef.child(key).set({
          id:key, date:now,
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          borrower: actorName,
          userId: userIdLine,
          itemCode: it.code,
          itemName: it.name,
          quantity: it.qty
        });
        // ‡∏•‡∏î stock
        await stockRef.child(it.code).child('quantity').transaction(c=>c-it.qty);
      }
      // ‡∏™‡πà‡∏á LIFF message ‡∏™‡∏£‡∏∏‡∏õ
      const txt = ['üì§ ‡πÄ‡∏ö‡∏¥‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', ...basket.map(it=>`${it.code}√ó${it.qty}`)].join('\n');
      await liff.sendMessages([{type:'text',text:txt}]);
      // ‡πÅ‡∏à‡πâ‡∏á Admin
      await notifyAdmins('issue-multi', basket);
      alertMsg('‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      basket=[]; updateBasketUI();
    };
  </script>
</body>
</html>
